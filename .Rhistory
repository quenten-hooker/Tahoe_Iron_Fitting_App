# library("dplyr")
# library("tidyr")
# library("lmerTest")
# library("ggpubr")
# library("GGally")
# library("emmeans")
# library("olsrr")
# library("readxl")
# library("ggforce")
# library("psych")
# library("jtools")
# library("sjPlot")
# library("sjmisc")
# library("kableExtra")
# library("knitr")
# library("sp")
# library("plotly")
# library("reshape2")
# library("ggeffects")
# library("MuMIn")
# library('lubridate')
# library('xlsx')
# library('stringi')
# library('fuzzyjoin')
# library('stringdist')
# library('reticulate')
# library('stringr')
#pacman::p_load(ggplot2, dplyr, tidyr, ggpubr, sjPlot, kableExtra, sp, plotly, ggeffects, akima, lme4, stringr, reshape)
library("dplyr")
library("reshape")
library("ggplot2")
library("lme4")
library("sjPlot")
library("ggeffects")
library("ggplot2")
library('tidyr')
library("dplyr")
library("reticulate")
library('lme4')
library('DT')
library('ggeffects')
library('shiny')
library('shinyWidgets')
library('shinythemes')
library('plotly')
library('caTools')
library('randomForest')
library('odbc')
library('DBI')
library('dplyr')
con <- DBI::dbConnect(odbc::odbc(),
Driver = "SQL Server",
Server = 'icgEngagedb.corp.callawaygolf.com',
Database = "Engage",
Trusted_Connection = "yes")
#dbListTables(con)
Data.Engage <- DBI::dbGetQuery(con,
"SELECT Date, ShotId, FittingId, AccountFullName, Location, EventName, BallFamilyName, CategoryId, CategoryName, ClubFamilyId,
ClubFamilyName, MonitorTypeName, ImpactHeadSpeedMph, ImpactAttackAngleDeg, ImpactPathAngleDeg,
ImpactYawAngleDeg, ImpactPitchAngleDeg, ImpactRollAngleDeg, ImpactHorizLocInch, ImpactVertLocInch,
BallSpeedMph, BallLaunchAngleDeg, BallSideAngleDeg, BallBackSpinRpm, BallSideSpinRpm, ShotApexFt,
ShotMaxLateralTravelFt, ShotCarryYd, ShotCarryDispFt, ShotTotalYd, ShotTotalDispFt,
ShotFlightTimeSec, SmashFactor
FROM Engage.cg_Engage.vwMeasuredShotsAll;")
Data.Engage %>% group_by(MonitorTypeName) %>% summarise(n())
Data.Engage %>% group_by(Location) %>% summarise(n())
Data.Engage %>% filter(EventName == 'Callaway Performance Center - Carlsbad') %>% group_by(AccountFullName) %>% summarise(n())
Data_Engage_Quad_Carlsbad <- Data.Engage %>% filter(EventName == 'Callaway Performance Center - Carlsbad')
Data_Engage_Quad_Carlsbad %>% group_by(FittingId) %>% summarise(num = n()) %>% arrange(desc(num))
Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons") %>% group_by(ClubFamilyName) %>% summarise(num = n()) %>% arrange(desc(num))
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph))
obs <- Data_Engage_Quad_Carlsbad_Iron_Select %>% group_by(FittingId) %>% summarise(num = n())
Data_Engage_Quad_Carlsbad_Iron_Select <- merge(Data_Engage_Quad_Carlsbad_Iron_Select, obs, by.x = c("FittingId"), by.y = c("FittingId"))
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(num > 7)
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)
#apply(Data_Engage_Quad_Carlsbad_Iron_Select,2,function(x) sum(is.na(x)))
sample.split(Data_Engage_Quad_Carlsbad_Iron_Select$ImpactHeadSpeedMph,SplitRatio = 0.80)->split_index
train  <- subset(Data_Engage_Quad_Carlsbad_Iron_Select,split_index==T)
test <- subset(Data_Engage_Quad_Carlsbad_Iron_Select,split_index==F)
train <- within(train, {
FittingId <- factor(as.character(FittingId))
ClubFamilyName <- factor(as.character(ClubFamilyName))})
test <- within(test, {
FittingId <- factor(as.character(FittingId))
ClubFamilyName <- factor(as.character(ClubFamilyName))})
# mod_regress <-lmer(ImpactHeadSpeedMph ~
#            # Fixed-effects
#            1 + BallSpeedMph*BallLaunchAngleDeg*BallSideAngleDeg*BallBackSpinRpm*BallSideSpinRpm*ClubFamilyName +
#            # Random-effects
#            (1 + BallSpeedMph + BallLaunchAngleDeg + BallSideAngleDeg + BallBackSpinRpm + BallSideSpinRpm | FittingId), data = train)
mod_regress <-lmer(ImpactHeadSpeedMph ~
# Fixed-effects
1 + BallSpeedMph + BallLaunchAngleDeg + BallSideAngleDeg + BallBackSpinRpm + BallSideSpinRpm + ClubFamilyName +
# Random-effects
(1 + BallSpeedMph + BallLaunchAngleDeg + BallSideAngleDeg + BallBackSpinRpm + BallSideSpinRpm | FittingId), data = train)
# mod_regress <- randomForest(ImpactHeadSpeedMph  ~
#                               BallSpeedMph + BallLaunchAngleDeg + BallSideAngleDeg + BallBackSpinRpm + BallSideSpinRpm + ClubFamilyName,
#                             data = train, ntree=1000, importance=TRUE)
#ggpredict(mod_regress)
#unique(as.numeric(row.names(ranef(mod_regress)$FittingId)))
result_regress <- predict(mod_regress,test, allow.new.levels = TRUE)
Final_Data <- cbind(Actual=test$ImpactHeadSpeedMph,Predicted=result_regress)
Final_Data <- as.data.frame(Final_Data)
error <- (Final_Data$Actual- Final_Data$Predicted)
Final_Data <- cbind(Final_Data,error)
Final_Data <- Final_Data %>% na.omit()
rmse1<-sqrt(mean(Final_Data$error^2))
rmse1
MSE.mem <- sum((Final_Data$error)^2)/nrow(test)
MSE.mem
ggplot(Final_Data, aes(x = Actual, y = Predicted)) + geom_point() + geom_smooth(method = "lm")
#library('tidyverse')
library('neuralnet')
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX TCB 21" ] <- "APEX_TCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX 21" ] <- "APEX_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX DCB 21" ] <- "APEX_DCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX PRO 21 IRONS" ] <- "APEX_PRO_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX MB 21" ] <- "APEX_MB_21"
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph))
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = SmashFactor)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = ImpactHeadSpeedMph)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)
data <- Data_Engage_Quad_Carlsbad_Iron_Select %>% select(ClubFamilyName, ImpactHeadSpeedMph, BallSpeedMph, BallLaunchAngleDeg, BallSideAngleDeg, BallBackSpinRpm, BallSideSpinRpm)
data <- data %>% filter(!row_number() %in% c(12838))
#summary(data)
data <- data %>% mutate(value = 1)  %>% spread(ClubFamilyName, value,  fill = 0)
data <- data %>% filter(!row_number() %in% c(12838))
data <- data %>% mutate(value = 1)  %>% spread(ClubFamilyName, value,  fill = 0)
unique(data)
#library('tidyverse')
library('neuralnet')
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX TCB 21" ] <- "APEX_TCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX 21" ] <- "APEX_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX DCB 21" ] <- "APEX_DCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX PRO 21 IRONS" ] <- "APEX_PRO_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX MB 21" ] <- "APEX_MB_21"
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph))
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = SmashFactor)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = ImpactHeadSpeedMph)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)
data <- Data_Engage_Quad_Carlsbad_Iron_Select %>% select(ClubFamilyName, ImpactHeadSpeedMph, BallSpeedMph, BallLaunchAngleDeg, BallSideAngleDeg, BallBackSpinRpm, BallSideSpinRpm)
data <- unique(data)
#summary(data)
data <- data %>% mutate(value = 1)  %>% spread(ClubFamilyName, value,  fill = 0)
#check for NAs
apply(data,2,function(x) sum(is.na(x)))
index <- sample(1:nrow(data),round(0.75*nrow(data)))
train <- data[index,]
test <- data[-index,]
lm.fit <- glm(ImpactHeadSpeedMph~., data=train)
summary(lm.fit)
pr.lm <- predict(lm.fit,test)
MSE.lm <- sum((pr.lm - test$ImpactHeadSpeedMph)^2)/nrow(test)
rmse.lm <- sqrt(mean((pr.lm - test$ImpactHeadSpeedMph)^2))
maxs <- apply(data, 2, max)
mins <- apply(data, 2, min)
scaled <- as.data.frame(scale(data, center = mins, scale = maxs - mins))
train_ <- scaled[index,]
test_ <- scaled[-index,]
n <- names(train_)
lhsOfFormula <- "ImpactHeadSpeedMph"
rhsOfFormula  <- paste(n[!n %in% "ImpactHeadSpeedMph"])
ns <- sapply(c(lhsOfFormula, rhsOfFormula), as.name)
f <- formula(paste(ns[1], paste(ns[-1], collapse="+"), sep=" ~ "))
#nn <- neuralnet(f,data=train_,hidden=c(5,3),linear.output=T)
nn <- neuralnet(formula = f, data = train_, hidden = 6, threshold = 0.01,
stepmax = 1e+05, rep = 1, startweights = NULL,
learningrate.limit = NULL, learningrate.factor = list(minus = 0.5,
plus = 1.2), learningrate = NULL, lifesign = "none",
lifesign.step = 1000, algorithm = "rprop+", err.fct = "sse",
act.fct = "logistic", linear.output = TRUE, exclude = NULL,
constant.weights = NULL, likelihood = FALSE)
plot(nn)
#library('tidyverse')
library('neuralnet')
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX TCB 21" ] <- "APEX_TCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX 21" ] <- "APEX_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX DCB 21" ] <- "APEX_DCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX PRO 21 IRONS" ] <- "APEX_PRO_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX MB 21" ] <- "APEX_MB_21"
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph))
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = SmashFactor)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = ImpactHeadSpeedMph)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)
data <- Data_Engage_Quad_Carlsbad_Iron_Select %>% select(ClubFamilyName, ImpactHeadSpeedMph, BallSpeedMph, BallLaunchAngleDeg, BallSideAngleDeg, BallBackSpinRpm, BallSideSpinRpm)
data <- unique(data)
#summary(data)
data <- data %>% mutate(value = 1)  %>% spread(ClubFamilyName, value,  fill = 0)
#check for NAs
apply(data,2,function(x) sum(is.na(x)))
index <- sample(1:nrow(data),round(0.75*nrow(data)))
train <- data[index,]
test <- data[-index,]
lm.fit <- glm(ImpactHeadSpeedMph~., data=train)
summary(lm.fit)
pr.lm <- predict(lm.fit,test)
MSE.lm <- sum((pr.lm - test$ImpactHeadSpeedMph)^2)/nrow(test)
rmse.lm <- sqrt(mean((pr.lm - test$ImpactHeadSpeedMph)^2))
maxs <- apply(data, 2, max)
mins <- apply(data, 2, min)
scaled <- as.data.frame(scale(data, center = mins, scale = maxs - mins))
train_ <- scaled[index,]
test_ <- scaled[-index,]
n <- names(train_)
lhsOfFormula <- "ImpactHeadSpeedMph"
rhsOfFormula  <- paste(n[!n %in% "ImpactHeadSpeedMph"])
ns <- sapply(c(lhsOfFormula, rhsOfFormula), as.name)
f <- formula(paste(ns[1], paste(ns[-1], collapse="+"), sep=" ~ "))
#nn <- neuralnet(f,data=train_,hidden=c(5,3),linear.output=T)
nn <- neuralnet(formula = f, data = train_, hidden = 4, threshold = 0.01,
stepmax = 1e+05, rep = 1, startweights = NULL,
learningrate.limit = NULL, learningrate.factor = list(minus = 0.5,
plus = 1.2), learningrate = NULL, lifesign = "none",
lifesign.step = 1000, algorithm = "rprop+", err.fct = "sse",
act.fct = "logistic", linear.output = TRUE, exclude = NULL,
constant.weights = NULL, likelihood = FALSE)
#library('tidyverse')
library('neuralnet')
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX TCB 21" ] <- "APEX_TCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX 21" ] <- "APEX_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX DCB 21" ] <- "APEX_DCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX PRO 21 IRONS" ] <- "APEX_PRO_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX MB 21" ] <- "APEX_MB_21"
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph))
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = SmashFactor)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = ImpactHeadSpeedMph)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)
data <- Data_Engage_Quad_Carlsbad_Iron_Select %>% select(ClubFamilyName, ImpactHeadSpeedMph, BallSpeedMph, BallLaunchAngleDeg, BallSideAngleDeg, BallBackSpinRpm, BallSideSpinRpm)
data <- unique(data)
#summary(data)
data <- data %>% mutate(value = 1)  %>% spread(ClubFamilyName, value,  fill = 0)
#check for NAs
apply(data,2,function(x) sum(is.na(x)))
index <- sample(1:nrow(data),round(0.75*nrow(data)))
train <- data[index,]
test <- data[-index,]
lm.fit <- glm(ImpactHeadSpeedMph~., data=train)
summary(lm.fit)
pr.lm <- predict(lm.fit,test)
MSE.lm <- sum((pr.lm - test$ImpactHeadSpeedMph)^2)/nrow(test)
rmse.lm <- sqrt(mean((pr.lm - test$ImpactHeadSpeedMph)^2))
maxs <- apply(data, 2, max)
mins <- apply(data, 2, min)
scaled <- as.data.frame(scale(data, center = mins, scale = maxs - mins))
train_ <- scaled[index,]
test_ <- scaled[-index,]
n <- names(train_)
lhsOfFormula <- "ImpactHeadSpeedMph"
rhsOfFormula  <- paste(n[!n %in% "ImpactHeadSpeedMph"])
ns <- sapply(c(lhsOfFormula, rhsOfFormula), as.name)
f <- formula(paste(ns[1], paste(ns[-1], collapse="+"), sep=" ~ "))
#nn <- neuralnet(f,data=train_,hidden=c(5,3),linear.output=T)
nn <- neuralnet(formula = f, data = train_, hidden = 4, threshold = 0.01,
stepmax = 1e+06, rep = 1, startweights = NULL,
#learningrate.limit = NULL,
#learningrate.factor = list(minus = 0.5,  plus = 1.2),
learningrate = NULL, lifesign = "minimal",
lifesign.step = 1000, algorithm = "rprop+", err.fct = "sse",
act.fct = "logistic", linear.output = TRUE, exclude = NULL,
constant.weights = NULL, likelihood = FALSE)
plot(nn)
pr.nn <- compute(nn,test_[,1:11])
pr.nn_ <- pr.nn$net.result*(max(data$ImpactHeadSpeedMph)-min(data$ImpactHeadSpeedMph))+min(data$ImpactHeadSpeedMph)
test.r <- (test_$ImpactHeadSpeedMph)*(max(data$ImpactHeadSpeedMph)-min(data$ImpactHeadSpeedMph))+min(data$ImpactHeadSpeedMph)
MSE.nn <- sum((test.r - pr.nn_)^2)/nrow(test_)
rmse.nn <- sqrt(mean((test.r - pr.nn_)^2))
print(paste(MSE.lm,MSE.nn))
print(paste(rmse.lm,rmse.nn))
par(mfrow=c(1,2))
plot(test$ImpactHeadSpeedMph,pr.nn_,col='red',main='Real vs predicted NN',pch=18,cex=0.7)
abline(0,1,lwd=2)
legend('bottomright',legend='NN',pch=18,col='red', bty='n')
plot(test$ImpactHeadSpeedMph,pr.lm,col='blue',main='Real vs predicted lm',pch=18, cex=0.7)
abline(0,1,lwd=2)
legend('bottomright',legend='LM',pch=18,col='blue', bty='n', cex=.95)
plot(test$ImpactHeadSpeedMph,pr.nn_,col='red',main='Real vs predicted NN',pch=18,cex=0.7)
points(test$ImpactHeadSpeedMph,pr.lm,col='blue',pch=18,cex=0.7)
abline(0,1,lwd=2)
legend('bottomright',legend=c('NN','LM'),pch=18,col=c('red','blue'))
par(mfrow=c(1,2))
plot(test$ImpactHeadSpeedMph,pr.nn_,col='red',main='Real vs predicted NN',pch=18,cex=0.7)
abline(0,1,lwd=2)
legend('bottomright',legend='NN',pch=18,col='red', bty='n')
plot(test$ImpactHeadSpeedMph,pr.lm,col='blue',main='Real vs predicted lm',pch=18, cex=0.7)
abline(0,1,lwd=2)
legend('bottomright',legend='LM',pch=18,col='blue', bty='n', cex=.95)
print(paste(rmse.lm,rmse.nn))
library(quantmod)
library(quantmod)
library(nnet)
library(caret)
f
model <- train(f, train_, method='nnet', linout=TRUE, trace = FALSE)
pr.nn <- compute(model,test_[,1:11])
plot(model)
model
ggplot(model)
result_regress <- predict(mod_regress,test_)
train_
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX TCB 21" ] <- "APEX_TCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX 21" ] <- "APEX_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX DCB 21" ] <- "APEX_DCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX PRO 21 IRONS" ] <- "APEX_PRO_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX MB 21" ] <- "APEX_MB_21"
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph))
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = SmashFactor)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = ImpactHeadSpeedMph)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)
data <- Data_Engage_Quad_Carlsbad_Iron_Select %>% select(ClubFamilyName, ImpactHeadSpeedMph, BallSpeedMph, BallLaunchAngleDeg, BallSideAngleDeg, BallBackSpinRpm, BallSideSpinRpm)
data <- unique(data)
#summary(data)
data <- data %>% mutate(value = 1)  %>% spread(ClubFamilyName, value,  fill = 0)
#check for NAs
apply(data,2,function(x) sum(is.na(x)))
index <- sample(1:nrow(data),round(0.75*nrow(data)))
train <- data[index,]
test <- data[-index,]
lm.fit <- glm(ImpactHeadSpeedMph~., data=train)
summary(lm.fit)
pr.lm <- predict(lm.fit,test)
MSE.lm <- sum((pr.lm - test$ImpactHeadSpeedMph)^2)/nrow(test)
rmse.lm <- sqrt(mean((pr.lm - test$ImpactHeadSpeedMph)^2))
maxs <- apply(data, 2, max)
mins <- apply(data, 2, min)
scaled <- as.data.frame(scale(data, center = mins, scale = maxs - mins))
train_ <- scaled[index,]
test_ <- scaled[-index,]
test_
result_regress <- predict(mod_regress,test_)
result_regress <- predict(model,test_)
result_regress
pr.nn
pr.nn_ <- result_regress*(max(data$ImpactHeadSpeedMph)-min(data$ImpactHeadSpeedMph))+min(data$ImpactHeadSpeedMph)
test.r <- (test_$ImpactHeadSpeedMph)*(max(data$ImpactHeadSpeedMph)-min(data$ImpactHeadSpeedMph))+min(data$ImpactHeadSpeedMph)
MSE.nn <- sum((test.r - pr.nn_)^2)/nrow(test_)
rmse.nn <- sqrt(mean((test.r - pr.nn_)^2))
rmse.nn
print(paste(MSE.lm,MSE.nn))
print(paste(rmse.lm,rmse.nn))
par(mfrow=c(1,2))
plot(test$ImpactHeadSpeedMph,pr.nn_,col='red',main='Real vs predicted NN',pch=18,cex=0.7)
abline(0,1,lwd=2)
legend('bottomright',legend='NN',pch=18,col='red', bty='n')
plot(test$ImpactHeadSpeedMph,pr.lm,col='blue',main='Real vs predicted lm',pch=18, cex=0.7)
abline(0,1,lwd=2)
legend('bottomright',legend='LM',pch=18,col='blue', bty='n', cex=.95)
plot(test$ImpactHeadSpeedMph,pr.nn_,col='red',main='Real vs predicted NN',pch=18,cex=0.7)
points(test$ImpactHeadSpeedMph,pr.lm,col='blue',pch=18,cex=0.7)
abline(0,1,lwd=2)
legend('bottomright',legend=c('NN','LM'),pch=18,col=c('red','blue'))
set.seed(7)
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX TCB 21" ] <- "APEX_TCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX 21" ] <- "APEX_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX DCB 21" ] <- "APEX_DCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX PRO 21 IRONS" ] <- "APEX_PRO_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX MB 21" ] <- "APEX_MB_21"
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph))
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = SmashFactor)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = ImpactHeadSpeedMph)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)
data <- Data_Engage_Quad_Carlsbad_Iron_Select %>% select(ClubFamilyName, ImpactHeadSpeedMph, BallSpeedMph, BallLaunchAngleDeg, BallSideAngleDeg, BallBackSpinRpm, BallSideSpinRpm)
data <- unique(data)
data <- data %>% mutate(value = 1)  %>% spread(ClubFamilyName, value,  fill = 0)
set.seed(7)
data
inTrain <- createDataPartition(
y = data$ImpactHeadSpeedMph,
p = .80,
list = FALSE
)
training <- Sonar[ inTrain,]
testing  <- Sonar[-inTrain,]
training <- data[ inTrain,]
testing  <- data[-inTrain,]
nn <- train(f, train_, method='nnet', linout=TRUE, trace = FALSE)
help(train)
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX TCB 21" ] <- "APEX_TCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX 21" ] <- "APEX_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX DCB 21" ] <- "APEX_DCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX PRO 21 IRONS" ] <- "APEX_PRO_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX MB 21" ] <- "APEX_MB_21"
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph))
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = SmashFactor)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = ImpactHeadSpeedMph)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)
data <- Data_Engage_Quad_Carlsbad_Iron_Select %>% select(ClubFamilyName, ImpactHeadSpeedMph, BallSpeedMph, BallLaunchAngleDeg, BallSideAngleDeg, BallBackSpinRpm, BallSideSpinRpm)
data <- unique(data)
#summary(data)
data <- data %>% mutate(value = 1)  %>% spread(ClubFamilyName, value,  fill = 0)
set.seed(7)
inTrain <- createDataPartition(
y = data$ImpactHeadSpeedMph,
p = .80,
list = FALSE
)
training <- data[ inTrain,]
testing  <- data[-inTrain,]
#nn <- train(f, train_, method='nnet', linout=TRUE, trace = FALSE, preProc = c("center", "scale"))
nn <- train(f, train_, method = "nnet", weights = NULL,
maximize = ifelse(metric == "RMSE", FALSE, TRUE),
trControl = trainControl(), tuneGrid = NULL, tuneLength = 3)
nn <- train(f, train_, method='nnet', linout=TRUE, trace = TRUE, preProc = c("center", "scale"))
library(doMC)
install.packages('doMC')
install.packages("doMC", repos="http://R-Forge.R-project.org")
library(doMC)
registerDoMC(cores=4)
training
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX TCB 21" ] <- "APEX_TCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX 21" ] <- "APEX_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX DCB 21" ] <- "APEX_DCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX PRO 21 IRONS" ] <- "APEX_PRO_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX MB 21" ] <- "APEX_MB_21"
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph))
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = SmashFactor)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = ImpactHeadSpeedMph)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)
data <- Data_Engage_Quad_Carlsbad_Iron_Select %>% select(ClubFamilyName, ImpactHeadSpeedMph, BallSpeedMph, BallLaunchAngleDeg, BallSideAngleDeg, BallBackSpinRpm, BallSideSpinRpm)
data <- unique(data)
#summary(data)
data <- data %>% mutate(value = 1)  %>% spread(ClubFamilyName, value,  fill = 0)
set.seed(7)
inTrain <- createDataPartition(
y = data$ImpactHeadSpeedMph,
p = .80,
list = FALSE
)
training <- data[ inTrain,]
testing  <- data[-inTrain,]
testing
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX TCB 21" ] <- "APEX_TCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX 21" ] <- "APEX_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX DCB 21" ] <- "APEX_DCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX PRO 21 IRONS" ] <- "APEX_PRO_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX MB 21" ] <- "APEX_MB_21"
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph))
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = SmashFactor)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = ImpactHeadSpeedMph)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)
data <- Data_Engage_Quad_Carlsbad_Iron_Select %>% select(ClubFamilyName, ImpactHeadSpeedMph, BallSpeedMph, BallLaunchAngleDeg, BallSideAngleDeg, BallBackSpinRpm, BallSideSpinRpm)
data <- unique(data)
#summary(data)
data <- data %>% mutate(value = 1)  %>% spread(ClubFamilyName, value,  fill = 0)
set.seed(7)
inTrain <- createDataPartition(
y = data$ImpactHeadSpeedMph,
p = .80,
list = FALSE
)
training <- data[ inTrain,]
testing  <- data[-inTrain,]
control <- trainControl(method="repeatedcv", number=10, repeats=3)
nn <- train(f, train_, method='nnet', linout=TRUE, trace = TRUE, trControl = control, preProc = c("center", "scale"))
results1 <- predict(nn, newdata=training)
conf1 <- confusionMatrix(results1, training$ImpactHeadSpeedMph)
print(model)
plot(nn)
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph))
obs <- Data_Engage_Quad_Carlsbad_Iron_Select %>% group_by(FittingId) %>% summarise(num = n())
Data_Engage_Quad_Carlsbad_Iron_Select <- merge(Data_Engage_Quad_Carlsbad_Iron_Select, obs, by.x = c("FittingId"), by.y = c("FittingId"))
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(num > 7)
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)
#apply(Data_Engage_Quad_Carlsbad_Iron_Select,2,function(x) sum(is.na(x)))
sample.split(Data_Engage_Quad_Carlsbad_Iron_Select$ImpactHeadSpeedMph,SplitRatio = 0.80)->split_index
train  <- subset(Data_Engage_Quad_Carlsbad_Iron_Select,split_index==T)
test <- subset(Data_Engage_Quad_Carlsbad_Iron_Select,split_index==F)
train <- within(train, {
FittingId <- factor(as.character(FittingId))
ClubFamilyName <- factor(as.character(ClubFamilyName))})
test <- within(test, {
FittingId <- factor(as.character(FittingId))
ClubFamilyName <- factor(as.character(ClubFamilyName))})
# mod_regress <-lmer(ImpactHeadSpeedMph ~
#            # Fixed-effects
#            1 + BallSpeedMph*BallLaunchAngleDeg*BallSideAngleDeg*BallBackSpinRpm*BallSideSpinRpm*ClubFamilyName +
#            # Random-effects
#            (1 + BallSpeedMph + BallLaunchAngleDeg + BallSideAngleDeg + BallBackSpinRpm + BallSideSpinRpm | FittingId), data = train)
mod_regress <-lmer(ImpactHeadSpeedMph ~
# Fixed-effects
1 + BallSpeedMph + BallLaunchAngleDeg + BallSideAngleDeg + BallBackSpinRpm + BallSideSpinRpm + ClubFamilyName +
# Random-effects
(1 + BallSpeedMph + BallLaunchAngleDeg + BallSideAngleDeg + BallBackSpinRpm + BallSideSpinRpm | FittingId), data = train)
# mod_regress <- randomForest(ImpactHeadSpeedMph  ~
#                               BallSpeedMph + BallLaunchAngleDeg + BallSideAngleDeg + BallBackSpinRpm + BallSideSpinRpm + ClubFamilyName,
#                             data = train, ntree=1000, importance=TRUE)
#ggpredict(mod_regress)
#unique(as.numeric(row.names(ranef(mod_regress)$FittingId)))
result_regress <- predict(mod_regress,test, allow.new.levels = TRUE)
Final_Data <- cbind(Actual=test$ImpactHeadSpeedMph,Predicted=result_regress)
Final_Data <- as.data.frame(Final_Data)
error <- (Final_Data$Actual- Final_Data$Predicted)
Final_Data <- cbind(Final_Data,error)
Final_Data <- Final_Data %>% na.omit()
rmse1<-sqrt(mean(Final_Data$error^2))
rmse1
MSE.mem <- sum((Final_Data$error)^2)/nrow(test)
MSE.mem
ggplot(Final_Data, aes(x = Actual, y = Predicted)) + geom_point() + geom_smooth(method = "lm")
par(mfrow=c(1,2))
plot(test$ImpactHeadSpeedMph,pr.nn_,col='red',main='Real vs predicted NN',pch=18,cex=0.7)
runApp('C:/Users/Quenten.hooker/OneDrive - Callaway Golf/quenten.hooker OneDrive/Innovation_projects/Irons/Tahoe_Iron_Fitting_App')
