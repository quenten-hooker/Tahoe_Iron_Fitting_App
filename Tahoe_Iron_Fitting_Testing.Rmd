---
title: "Tahoe Iron Fitting App - Data format and test"
author: "Quenten Hooker"
date: "4/17/2023"
output: 
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
  html_notebook: default
urlcolor: blue
---

- Goal
- someone enter in a few swing parameters and give downrange and trajectory data for a few clubs

```{r , echo=FALSE, include = FALSE, warning=FALSE}

# library("ggplot2")
# library("lme4")
# library("car")
# library("dplyr")
# library("tidyr")
# library("lmerTest")
# library("ggpubr")
# library("GGally")
# library("emmeans")
# library("olsrr")
# library("readxl")
# library("ggforce")
# library("psych")
# library("jtools")
# library("sjPlot")
# library("sjmisc")
# library("kableExtra")
# library("knitr")
# library("sp")
# library("plotly")
# library("reshape2")
# library("ggeffects")
# library("MuMIn")
# library('lubridate')
# library('xlsx')
# library('stringi')
# library('fuzzyjoin')
# library('stringdist')
library('reticulate')
# library('stringr')

#pacman::p_load(ggplot2, dplyr, tidyr, ggpubr, sjPlot, kableExtra, sp, plotly, ggeffects, akima, lme4, stringr, reshape)
library("dplyr")
library("reshape")
library("ggplot2")
library("lme4")
library("sjPlot")
library("ggeffects")

library("ggplot2")
library('tidyr')
library("dplyr")
library("reticulate")
library('lme4')
library('DT')
library('ggeffects')
library('shiny')
library('shinyWidgets')
library('shinythemes')
library('plotly')
library('caTools')
library('randomForest')

```

#Glob and format to merge Core panel data
```{r , echo=TRUE, include = TRUE}

# Path <- "E:/4716/Shared Documents/91362/05 - Player Test/"
# 
# dat.files  <- list.files(path= Path,
#                                recursive=T,
#                                pattern=c(".csv"),
#                                full.names=T)
# 
# #function for reading each cg/moi
# readDatFile <- function(f) {
#   #dat.fl <- read_excel(path = f, sheet= 1, col_names = TRUE, skip = 0)
#   dat.fl <- read.csv(f, header = TRUE, sep=",", skip = 4,  
#                na.strings=c("NA","NaN"," ",""))
# }
# 
# Data.Quad <- c()
#   
# #Look for sheet names to help scraper 
# for (i in 1:length(dat.files)) {
#  
#   temp <- readDatFile(dat.files[i])
#   temp$Player <- sub(".*/", "", dat.files[i])
#   temp$Player <-  substr(temp$Player, 1, nchar(temp$Player)-4)
#   Data.Quad <- rbind(Data.Quad, temp)
#   
# }
# 
# Data.Quad 
# 
# Data.Quad$Club[Data.Quad$Club.ID == "Club A"] <- "AW"
# Data.Quad$Club[Data.Quad$Club.ID == "Club B"] <- "9 Iron"
# Data.Quad$Club[Data.Quad$Club.ID == "Club C"] <- "AW"
# Data.Quad$Club[Data.Quad$Club.ID == "Club D"] <- "9 Iron"
# 
# Data.Quad$Model[Data.Quad$Club.ID == "Club D" | Data.Quad$Club.ID == "Club C" ] <- "Tahoe HL"
# Data.Quad$Model[Data.Quad$Club.ID == "Club A" | Data.Quad$Club.ID == "Club B" ] <- "Tahoe Std"
# 
# #Data.Quad.03 <- Data.Quad
# #Data.Quad.04 <- Data.Quad
# #Data.Quad.05 <- Data.Quad
# 
# Data.Combined <- rbind(Data.Quad.03, Data.Quad.04, Data.Quad.05)
# Data.Combined$Tags <- Data.Combined$Model
# Data.Combined$FullTag <- paste(Data.Combined$Club, Data.Combined$Model, sep = ", " )
# 
# Data.Combined <- Data.Combined %>% relocate(Player, Club, Tags, FullTag) %>% relocate(Time, .after = Vertical.Face.Impact..mm.....is.up.) %>% relocate(Shot.Color..R.G.B., .after = Time)
# 
# col_names <- c("Player", "Club", "Tags", "FullTag", "Shot.ID", "Selected", "Date.quad", "Club.Type", "Club.ID", "Range.Ball.quad", "Ball.Speed.quad","Launch.Angle.quad", "Side.Angle.quad", "Side.Spin.quad", "Back.Spin.quad", "Tilt.Angle.quad", "Spin.Rate.quad", "Peak.Height.quad", "Carry.quad", "Range.quad", "Offline.quad", "Descent.Angle.quad", "Club.Speed.quad" ,"Efficiency.quad", "Angle.Of.Attack.quad", "Club.Path.quad", "Face.To.Target.quad", "Face.To.Path.quad", "Lie.quad", "Loft.quad", "Closing.Rate.quad", "Impact.Speed.quad", "Lateral.Face.quad", "Vertical.Face.quad", "Time", "Shot.Color", "Model")
# colnames(Data.Combined) <- col_names
# 
# #write.csv(Data.Combined, "Core_Panel_Glob.csv")

```


```{r , echo=FALSE, include = TRUE, warning=FALSE}

player_speed <- 98.3
player_attack <- -4.8
player_pitch <- -7.0	

```

# Read data and reformat
```{r , echo=FALSE, include = TRUE, warning=FALSE}

Data <- read.csv('Gold_Panel_Glob.csv')

col_names <- c("Player", "Club", "Tags", "FullTag", "Shot.ID", "Selected", "Date.quad", "Club.Type", "Club.ID", "Range.Ball.quad", "Ball.Speed.quad","Launch.Angle.quad", "Side.Angle.quad", "Side.Spin.quad", "Back.Spin.quad", "Tilt.Angle.quad", "Spin.Rate.quad", "Peak.Height.quad", "Carry.quad", "Range.quad", "Offline.quad", "Descent.Angle.quad", "Club.Speed.quad" ,"Efficiency.quad", "Angle.Of.Attack.quad", "Club.Path.quad", "Face.To.Target.quad", "Face.To.Path.quad", "Lie.quad", "Loft.quad", "Closing.Rate.quad", "Impact.Speed.quad", "Lateral.Face.quad", "Vertical.Face.quad", "Time", "Shot.Color")

colnames(Data) <- col_names

Data$Model <- Data$Tags

Data.core <- read.csv('Core_Panel_Glob.csv')
Data <- rbind(Data, Data.core)

Data %>% group_by(Tags) %>% summarise(n())
Data %>% group_by(Player) %>% summarise(n())

Data %>% filter(Model == "Tahoe HL") %>% group_by(Club) %>% summarise(n())

```

#Creating length and static loft columns
```{r , echo=FALSE, include = TRUE, warning=FALSE}

Data$Length[Data$Club== "PW"] <- 35.75
Data$Length[Data$Club== "9 Iron"] <- 36.0
Data$Length[Data$Club== "8 Iron"] <- 36.5
Data$Length[Data$Club== "7 Iron"] <- 37.0
Data$Length[Data$Club== "6 Iron"] <- 37.5
Data$Length[Data$Club== "5 Iron"] <- 38.0

Data$Length[Data$Club== "AW" & Data$Model == "Tahoe Std"] <- 35.5
Data$Length[Data$Club== "9 Iron" & Data$Model == "Tahoe Std"] <- 36.0
Data$Length[Data$Club== "7 Iron" & Data$Model == "Tahoe Std"] <- 37.25
Data$Length[Data$Club== "5 Iron" & Data$Model == "Tahoe Std"] <- 38.5

Data$Length[Data$Club== "AW" & Data$Model == "Tahoe HL"] <- 35.5
Data$Length[Data$Club== "9 Iron" & Data$Model == "Tahoe HL"] <- 36.0
Data$Length[Data$Club== "7 Iron" & Data$Model == "Tahoe HL"] <- 37.5
Data$Length[Data$Club== "5 Iron" & Data$Model == "Tahoe HL"] <- 39.0

Data$Length[Data$Club== "PW"] <- 35.75
Data$Length[Data$Club== "9 Iron"] <- 36.0
Data$Length[Data$Club== "8 Iron"] <- 36.5
Data$Length[Data$Club== "7 Iron"] <- 37.0
Data$Length[Data$Club== "6 Iron"] <- 37.5
Data$Length[Data$Club== "5 Iron"] <- 38.0

Data$Static.Loft[Data$Club == "PW" & Data$Model == "TCB"] <- 46.75
Data$Static.Loft[Data$Club == "9 Iron" & Data$Model == "TCB"] <- 42.5
Data$Static.Loft[Data$Club == "8 Iron" & Data$Model == "TCB"] <- 39
Data$Static.Loft[Data$Club == "7 Iron" & Data$Model == "TCB"] <- 34.75
Data$Static.Loft[Data$Club == "6 Iron" & Data$Model == "TCB"] <- 30.25
Data$Static.Loft[Data$Club == "5 Iron" & Data$Model == "TCB"] <- 26.5

Data$Static.Loft[Data$Club == "PW" & Data$Model == "MB21"] <- 46
Data$Static.Loft[Data$Club == "9 Iron" & Data$Model == "MB21"] <- 42.5
Data$Static.Loft[Data$Club == "8 Iron" & Data$Model == "MB21"] <- 38.25
Data$Static.Loft[Data$Club == "7 Iron" & Data$Model == "MB21"] <- 34.25
Data$Static.Loft[Data$Club == "6 Iron" & Data$Model == "MB21"] <- 30.5
Data$Static.Loft[Data$Club == "5 Iron" & Data$Model == "MB21"] <- 26.25

Data$Static.Loft[Data$Club == "AW" & Data$Model == "Tahoe Std"] <- 47.0
Data$Static.Loft[Data$Club == "9 Iron" & Data$Model == "Tahoe Std"] <- 37.0
Data$Static.Loft[Data$Club == "7 Iron" & Data$Model == "Tahoe Std"] <- 29.0
Data$Static.Loft[Data$Club == "5 Iron" & Data$Model == "Tahoe Std"] <- 23.0

Data$Static.Loft[Data$Club == "AW" & Data$Model == "Tahoe HL"] <- 48.0
Data$Static.Loft[Data$Club == "9 Iron" & Data$Model == "Tahoe HL"] <- 38.0
Data$Static.Loft[Data$Club == "7 Iron" & Data$Model == "Tahoe HL"] <- 30.0
Data$Static.Loft[Data$Club == "5 Iron" & Data$Model == "Tahoe HL"] <- 24.0

```

```{r , echo=FALSE, include = TRUE, warning=FALSE}

Data <- within(Data, {
  Player <- factor(Player)
  Club <- factor(Club)
  Club.Speed.quad <- as.numeric(Club.Speed.quad)
  Efficiency.quad <- as.numeric(Efficiency.quad)
  Angle.Of.Attack.quad <- as.numeric(Angle.Of.Attack.quad)
  Club.Path.quad <- as.numeric(Club.Path.quad)
  Face.To.Target.quad <- as.numeric(Face.To.Target.quad)
  Face.To.Path.quad <- as.numeric(Face.To.Path.quad)
  Lie.quad <- as.numeric(Lie.quad)
  Loft.quad <- as.numeric(Loft.quad)
  Lateral.Face.quad <- as.numeric(Lateral.Face.quad)*-1
  Vertical.Face.quad <- as.numeric(Vertical.Face.quad)
  })

Data$Pitch <- Data$Loft.quad - Data$Static.Loft
Data.Combined <- Data

```


# Filtering functions
```{r , echo=FALSE, include = TRUE, warning=FALSE}

# create detect outlier function
# detect_outlier <- function(x) {
# 
# 	# calculate first quantile
# 	Quantile1 <- quantile(x %>% na.omit(), probs=.25)
# 
# 	# calculate third quantile
# 	Quantile3 <- quantile(x %>% na.omit(), probs=.75)
# 
# 	# calculate inter quartile range
# 	IQR = Quantile3-Quantile1
# 
# 	# return true or false
# 	x > Quantile3 + (IQR*1.5) | x < Quantile1 - (IQR*1.5)
# }
# 
# # create remove outlier function
# remove_outlier <- function(dataframe,
# 							columns=names(dataframe)) {
# 
# 	# for loop to traverse in columns vector
# 	for (col in columns) {
# 
# 		# remove observation if it satisfies outlier function
# 		temp <- !detect_outlier(dataframe[[col]])
# 		temp[temp = NA] <- TRUE
# 	  dataframe <- dataframe[, ]
# 	}
# 
# 	# return dataframe
# 	print("Remove outliers")
# 	print(dataframe)
# }

```


```{r , echo=FALSE, include = TRUE, warning=FALSE}

data_long_ball <- melt(Data.Combined %>% select(Ball.Speed.quad, Launch.Angle.quad, Side.Angle.quad, Side.Spin.quad, Back.Spin.quad))

data_long_club <- melt(Data.Combined %>% select(Club.Speed.quad, Angle.Of.Attack.quad, Club.Path.quad, Face.To.Target.quad, Face.To.Path.quad, Lie.quad, Pitch, Lateral.Face.quad, Vertical.Face.quad))

ggplot(data_long_ball, aes(x=value,)) + geom_boxplot() + facet_wrap(~variable, scale="free")
ggplot(data_long_club, aes(x=value,)) + geom_boxplot() + facet_wrap(~variable, scale="free")

Data.Combined <- Data.Combined %>% filter(Ball.Speed.quad > 50, Launch.Angle.quad < 50, Side.Angle.quad < 25, Side.Spin.quad < 2000, Back.Spin.quad > 3000, Face.To.Target.quad < 15, Face.To.Target.quad > -15, Lie.quad < 20, Lie.quad > -20, Pitch > -25, Pitch < 0, Lateral.Face.quad > -20, Lateral.Face.quad < 20, Vertical.Face.quad < 10, Vertical.Face.quad > -30)

```

# Modeling dynamics
```{r , echo=FALSE, include = TRUE, warning=FALSE}

ggplot(Data.Combined, aes(x = Length, y = Club.Speed.quad)) + geom_point(aes(color = Player)) + geom_smooth(aes(color = Player), method = "lm", formula = y ~ x + I(x^2), se=TRUE, level = .8, linetype = 1)+ theme_classic() + theme(legend.key.size = unit(.5, 'cm'), legend.key.width= unit(.1, 'cm'), legend.text = element_text(size=7))

ggplot(Data.Combined, aes(x = Length, y = Angle.Of.Attack.quad)) + geom_point(aes(color = Player)) + geom_smooth(aes(color = Player), method = "lm", formula = y ~ x + I(x^2), se=TRUE, level = .8, linetype = 1)+ theme_classic() + theme(legend.key.size = unit(.5, 'cm'), legend.key.width= unit(.1, 'cm'), legend.text = element_text(size=7))

ggplot(Data.Combined, aes(x = Length, y = Club.Path.quad)) + geom_point(aes(color = Player)) + geom_smooth(aes(color = Player), method = "lm", formula = y ~ x + I(x^2), se=TRUE, level = .8, linetype = 1)+ theme_classic() + theme(legend.key.size = unit(.5, 'cm'), legend.key.width= unit(.1, 'cm'), legend.text = element_text(size=7)) 

ggplot(Data.Combined, aes(x = Length, y = Pitch)) + geom_point(aes(color = Player)) + geom_smooth(aes(color = Player), method = "lm", formula = y ~ x + I(x^2), se=TRUE, level = .8, linetype = 1)+ theme_classic() + theme(legend.key.size = unit(.5, 'cm'), legend.key.width= unit(.1, 'cm'), legend.text = element_text(size=7)) 


ggplot(Data.Combined, aes(x = Length, y = Ball.Speed.quad)) + geom_point(aes(color = Player)) + geom_smooth(aes(color = Player), method = "lm", formula = y ~ x + I(x^2), se=TRUE, level = .8, linetype = 1)+ theme_classic() + theme(legend.key.size = unit(.5, 'cm'), legend.key.width= unit(.1, 'cm'), legend.text = element_text(size=7))



lm.Club.Speed.quad <-lmer(Club.Speed.quad ~
           # Fixed-effects
           1 + Length + I(Length^2) +
           # Random-effects
           (1 + Length + I(Length^2) | Player), data = Data.Combined)

lm.Angle.Of.Attack.quad <-lmer(Angle.Of.Attack.quad ~
           # Fixed-effects
           1 + Length + I(Length^2) +
           # Random-effects
           (1 + Length + I(Length^2) | Player), data = Data.Combined)

lm.Pitch <-lmer(Pitch ~
           # Fixed-effects
           1 + Length + I(Length^2) +
           # Random-effects
           (1 + Length + I(Length^2) | Player), data = Data.Combined)

plot_model(lm.Club.Speed.quad, type = "pred", terms = c("Length[all]"), ci.lvl = NA, show.data = TRUE)+theme_sjplot()
plot_model(lm.Angle.Of.Attack.quad, type = "pred", terms = c("Length[all]"), ci.lvl = NA, show.data = TRUE)+theme_sjplot()
plot_model(lm.Pitch, type = "pred", terms = c("Length[all]"), ci.lvl = NA, show.data = TRUE)+theme_sjplot()

plot_model(lm.Club.Speed.quad, type = "pred", pred.type = ("re"), terms = c("Length[all]", "Player"), show.data = FALSE, ci.lvl =NA)+theme_sjplot()
plot_model(lm.Angle.Of.Attack.quad, type = "pred", pred.type = ("re"), terms = c("Length[all]", "Player"), show.data = FALSE, ci.lvl =NA)+theme_sjplot()
plot_model(lm.Pitch, type = "pred", pred.type = ("re"), terms = c("Length[all]", "Player"), show.data = FALSE, ci.lvl =NA)+theme_sjplot()

```

```{r , echo=FALSE, include = FALSE, warning=FALSE, message = FALSE}

Data.Combined.train <- Data.Combined %>% filter(Model == "Tahoe Std" | Model == "Tahoe HL")

# Data.Combined.train$Model[Data.Combined.train$Model== "MB21"] <- "Tahoe (test)"
# Data.Combined.train$Model[Data.Combined.train$Model== "TCB"] <- "Tahoe HL (test)"

Data.Combined.train <- within(Data.Combined.train, {
  Model <- factor(as.character(Model))
  })

Data.Combined.train <-  Data.Combined.train %>% arrange(Player, Club, Model)
Data.Combined %>% group_by(Model) %>% summarise(n())

lm.Ball.Speed.normalize <-lmer(Ball.Speed.quad ~
           # Fixed-effects
           1 + Model + Club.Speed.quad + Pitch + Length:Club.Speed.quad + Length:Pitch + Vertical.Face.quad + Lateral.Face.quad +
             Model:Vertical.Face.quad + Model:Lateral.Face.quad + Model:I(Vertical.Face.quad^2) + Model:I(Lateral.Face.quad^2) +
           # Random-effects
           (1 + Club.Speed.quad + Pitch + Vertical.Face.quad + Lateral.Face.quad| Player), data = Data.Combined.train)

lm.Launch.Angle.normalize <-lmer(Launch.Angle.quad ~
                                   # Fixed-effects
                                   1 + Model + Club.Speed.quad + Angle.Of.Attack.quad + Pitch + Vertical.Face.quad + Length:Pitch + Vertical.Face.quad + 
                                   Static.Loft:Club.Speed.quad + Static.Loft:Angle.Of.Attack.quad + Static.Loft:Pitch + Static.Loft:Vertical.Face.quad +
                                   # Random-effects
                                   (1 + Club.Speed.quad + Angle.Of.Attack.quad + Pitch + Vertical.Face.quad| Player), data = Data.Combined.train)

lm.Back.Spin.normalize <-lmer(Back.Spin.quad ~
           # Fixed-effects
           1 + Model + Angle.Of.Attack.quad + Pitch + Vertical.Face.quad +
             Length:Pitch + Length:Vertical.Face.quad + Static.Loft:Club.Speed.quad + Static.Loft:Vertical.Face.quad +
           # Random-effects
           (1 + Angle.Of.Attack.quad + Pitch + Vertical.Face.quad| Player), data = Data.Combined.train)

lm.Side.Angle.normalize <-lmer(Side.Angle.quad ~
           # Fixed-effects
           1 + Length*Club.Speed.quad + Length*Face.To.Target.quad + Length*Lateral.Face.quad +
           # Random-effects
           (1 + Club.Speed.quad + Face.To.Target.quad + Lateral.Face.quad | Player), data = Data.Combined.train)

lm.Side.Spin.normalize <-lmer(Side.Spin.quad ~
           # Fixed-effects
           1 + Length*Club.Speed.quad + Length*Face.To.Path.quad + Length*Lateral.Face.quad  +
           # Random-effects
           (1 + Club.Speed.quad + Face.To.Path.quad + Lateral.Face.quad | Player), data = Data.Combined.train)

```

## Ball Speed Evaluation
```{r , echo=FALSE, include = TRUE, warning=FALSE, , message = FALSE}

summary(lm.Ball.Speed.normalize)

plot_model(lm.Ball.Speed.normalize, type = "pred", terms = c("Club.Speed.quad", "Length", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

# plot_model(lm.Ball.Speed.normalize, type = "pred", terms = c("Angle.Of.Attack.quad", "Length", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Ball.Speed.normalize, type = "pred", terms = c("Pitch", "Length", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Ball.Speed.normalize, type = "pred", terms = c("Vertical.Face.quad", "Length", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Ball.Speed.normalize, type = "pred", terms = c("Lateral.Face.quad", "Length", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()


```


## Launch Angle Evaluation
```{r , echo=FALSE, include = TRUE, warning=FALSE, , message = FALSE}

lm.Launch.Angle.normalize <-lmer(Launch.Angle.quad ~
                                   # Fixed-effects
                                   1 + Model + Club.Speed.quad + Angle.Of.Attack.quad + Pitch + Vertical.Face.quad + Length:Pitch + Vertical.Face.quad + 
                                   Static.Loft:Club.Speed.quad + Static.Loft:Angle.Of.Attack.quad + Static.Loft:Pitch + Static.Loft:Vertical.Face.quad +
                                   # Random-effects
                                   (1 + Club.Speed.quad + Angle.Of.Attack.quad + Pitch + Vertical.Face.quad| Player), data = Data.Combined.train)

#summary(lm.Launch.Angle.normalize)

#ggpredict(lm.Launch.Angle.normalize)

plot_model(lm.Launch.Angle.normalize, type = "pred", terms = c("Club.Speed.quad", "Length", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Launch.Angle.normalize, type = "pred", terms = c("Club.Speed.quad", "Static.Loft", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()


plot_model(lm.Launch.Angle.normalize, type = "pred", terms = c("Angle.Of.Attack.quad", "Length", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Launch.Angle.normalize, type = "pred", terms = c("Angle.Of.Attack.quad", "Static.Loft", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()


plot_model(lm.Launch.Angle.normalize, type = "pred", terms = c("Pitch", "Length", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Launch.Angle.normalize, type = "pred", terms = c("Pitch", "Static.Loft", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()


plot_model(lm.Launch.Angle.normalize, type = "pred", terms = c("Vertical.Face.quad", "Length", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Launch.Angle.normalize, type = "pred", terms = c("Vertical.Face.quad", "Static.Loft", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

```

## Backspin Evaluation
```{r , echo=FALSE, include = TRUE, warning=FALSE, , message = FALSE}

lm.Back.Spin.normalize <-lmer(Back.Spin.quad ~
                                # Fixed-effects
                                1 + Model:Length + Static.Loft + Angle.Of.Attack.quad + Pitch + Vertical.Face.quad + Club.Speed.quad +
                                # Random-effects
                                (1 + Angle.Of.Attack.quad + Pitch + Vertical.Face.quad| Player), data = Data.Combined.train)

ggpredict(lm.Back.Spin.normalize)

#plot_model(lm.Back.Spin.normalize, type = "pred", terms = c("Club.Speed.quad", "Length", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Back.Spin.normalize, type = "pred", terms = c("Angle.Of.Attack.quad", "Length", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Back.Spin.normalize, type = "pred", terms = c("Pitch", "Length", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Back.Spin.normalize, type = "pred", terms = c("Vertical.Face.quad", "Length", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Back.Spin.normalize, type = "pred", terms = c("Club.Speed.quad", "Static.Loft", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Back.Spin.normalize, type = "pred", terms = c("Angle.Of.Attack.quad", "Static.Loft", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Back.Spin.normalize, type = "pred", terms = c("Pitch", "Static.Loft", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Back.Spin.normalize, type = "pred", terms = c("Vertical.Face.quad", "Static.Loft", "Model"), show.data = TRUE)+theme_sjplot()+theme_classic()

```

## Side Angle Evaluation
```{r , echo=FALSE, include = TRUE, warning=FALSE, , message = FALSE}

lm.Side.Angle.normalize <-lmer(Side.Angle.quad ~
           # Fixed-effects
           1 + Length*Face.To.Target.quad + Length*Lateral.Face.quad +
           # Random-effects
           (1 + Face.To.Target.quad + Lateral.Face.quad | Player), data = Data.Combined.train)

ggpredict(lm.Side.Angle.normalize)

plot_model(lm.Side.Angle.normalize, type = "pred", terms = c("Club.Speed.quad", "Length"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Side.Angle.normalize, type = "pred", terms = c("Face.To.Target.quad", "Length"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Side.Angle.normalize, type = "pred", terms = c("Lateral.Face.quad", "Length"), show.data = TRUE)+theme_sjplot()+theme_classic()

```


## Sidespin Evaluation
```{r , echo=FALSE, include = TRUE, warning=FALSE, , message = FALSE}

lm.Side.Spin.normalize <-lmer(Side.Spin.quad ~
                                # Fixed-effects
                                1 + Face.To.Path.quad + Lateral.Face.quad  +
                                # Random-effects
                                (1 + Face.To.Path.quad + Lateral.Face.quad | Player), data = Data.Combined.train)

ggpredict(lm.Side.Spin.normalize)

#plot_model(lm.Side.Spin.normalize, type = "pred", terms = c("Club.Speed.quad", "Length"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Side.Spin.normalize, type = "pred", terms = c("Face.To.Path.quad", "Length"), show.data = TRUE)+theme_sjplot()+theme_classic()

plot_model(lm.Side.Spin.normalize, type = "pred", terms = c("Lateral.Face.quad", "Length"), show.data = TRUE)+theme_sjplot()+theme_classic()

```

## Prep for building test data frame
```{r , echo=FALSE, include = TRUE, warning=FALSE, , message = FALSE}

Tahoe_length <- c(35.75, 36.0, 36.625, 37.25, 37.875, 38.5)
Tahoe_static_loft <- c(42, 37, 33, 29, 26, 23)
Tahoe_HL_length <- c(35.75, 36.0, 36.75, 37.5, 38.25, 39.0)
Tahoe_HL_static_loft <- c(43, 38, 34, 30, 27, 24)

Length.data <- data.frame(Length = c(rep(Tahoe_length, each = 8), rep(Tahoe_HL_length, each = 8)))
Static_Loft.data <- data.frame(Loft = c(rep(Tahoe_static_loft, each = 8), rep(Tahoe_HL_static_loft, each = 8)))

player_speed_dif <- (player_speed - ggpredict(lm.Club.Speed.quad, terms = "Length[37.5]")$predicted)
player_attack_dif <- (player_attack - ggpredict(lm.Angle.Of.Attack.quad, terms = "Length[37.5]")$predicted)
player_pitch_dif <- (player_pitch- ggpredict(lm.Pitch, terms = "Length[37.5]")$predicted)

#seed and norm vector
set.seed(6)#14
x <- rnorm(8, 0, 1)
Lateral.Impact.GMM <- scales::rescale(x, to = c(-15, 15), from = range(x))

mean(Lateral.Impact.GMM)

set.seed(14)
y <- rnorm(8, 0, 1)
Vertical.Impact.GMM <- scales::rescale(y, to = c(-20, 0), from = range(y))

#test <- data.frame(Lateral.Impact.GMM, Vertical.Impact.GMM)
#ggplot(test, aes(Lateral.Impact.GMM, Vertical.Impact.GMM)) + geom_point()

```

## Test data frame
```{r , echo=FALSE, include = TRUE, warning=FALSE, , message = FALSE}

new_data = c()
new_data <- data.frame(Player = rep("Population", nrow(Length.data)),
                       Model = rep(c("Tahoe Std", "Tahoe HL"), each = 48),
                       Length =c(rep(Tahoe_length, each = 8), rep(Tahoe_HL_length, each = 8)),
                       Static.Loft = c(rep(Tahoe_static_loft, each = 8), rep(Tahoe_HL_static_loft, each = 8)),
                       Club.Speed.quad = predict(lm.Club.Speed.quad, re.form= NA, newdata = Length.data) + player_speed_dif,
                       Angle.Of.Attack.quad = predict(lm.Angle.Of.Attack.quad, re.form= NA, newdata = Length.data) + player_attack_dif,
                       Face.To.Target.quad = 0,
                       Club.Path.quad = 0,
                       Face.To.Path.quad = 0,
                       Pitch = predict(lm.Pitch, re.form= NA, newdata = Length.data) + player_pitch_dif,
                       Lie.quad = rep(mean(na.omit(Data.Combined.train$Lie.quad)), 96),
                       Lateral.Face.quad = rep(Lateral.Impact.GMM, 12),
                       Vertical.Face.quad = rep(Vertical.Impact.GMM, 12))

new_data %>% group_by(Model, Length) %>% summarise(Club.Speed.quad = mean(Club.Speed.quad), Angle.Of.Attack.quad = mean(Angle.Of.Attack.quad), Pitch = mean(Pitch))

```

## predict data frame
```{r , echo=FALSE, include = TRUE, warning=FALSE, , message = FALSE}
predict_data = c()
predict_data$Model = new_data$Model
predict_data$Length = new_data$Length
predict_data$Ball.Speed <- predict(lm.Ball.Speed.normalize, re.form= NA, newdata = new_data)
predict_data$Back.Spin <- predict(lm.Back.Spin.normalize, re.form= NA, newdata = new_data)
predict_data$Launch.Angle <- predict(lm.Launch.Angle.normalize, re.form= NA, newdata = new_data)
predict_data$Side.Spin <- predict(lm.Side.Spin.normalize, re.form= NA, newdata = new_data)
predict_data$Side.Angle <- predict(lm.Side.Angle.normalize, re.form= NA, newdata = new_data)
predict_data <- data.frame(predict_data)


#Data.Combined.train %>% filter(Player == "Quenten Hooker") %>% group_by(Player, Length) %>% summarise(mean(Club.Speed.quad), mean(Pitch), mean(Angle.Of.Attack.quad))

```

## Aero code
```{r , echo=FALSE, include = FALSE, warning=FALSE}

model_col_names <- c("Model", "Club", "speed-mph", "back_spin-rpm", "launch_angle-deg", "side_spin-rpm",
                     "side_angle-deg")

colnames(predict_data) <- as.character(model_col_names)
aero_data <- predict_data %>% select("speed-mph", "back_spin-rpm", "launch_angle-deg", "side_spin-rpm",
                     "side_angle-deg")

```

```{r , echo=FALSE, include = TRUE, warning=FALSE}

library(reticulate)
use_python("C:/Users/Quenten.hooker/AppData/Local/Programs/Python/Python39/python.exe", required=TRUE)

```


```{python, echo=FALSE, include = TRUE, warning=FALSE}

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import scipy as scipy
import downrange.downrange as downrange

#demo = downrange.Downrange()

environment = {
        'env_temp_F':  75, #[deg F]
        'env_rh-percent' : 50, #[% relative humidity]
        'env_pre-psi': 14.7, #[psi]
        'gravity' : 9.8066352, #[m/s^2], value from Petrisor's code
        'wind' : [0,0,0] #X,Y,Z - positive = downwind, __, __
        }
        
ball_properties={
        'ball_size-inch': 1.6822,
        'ball_mass-g':45.538,
        'ball_moi-ozins2': 0.0011609
        }
        
#aerosurfacepath='C:/Users/Quenten.hooker/AppData/Local/Programs/Python/Python39/Lib/site-packages/downrange/ITRdata/8323/'

demo = downrange.Downrange(
                            environment=environment,
                            ball_properties=ball_properties,
                            #aerosurfacepath=aerosurfacepath
                            )
``` 


```{python, echo=FALSE, include = FALSE, warning=FALSE, message = FALSE}

# 131.0761	5626.937	13.10392	-86.35503	-0.52511924
# 
# launch= {
#         'speed-mph':131.0761,
#         'back_spin-rpm' : 5626.937,
#         'launch_angle-deg' : 13.10392,
#         'side_spin-rpm' : -86.35503,
#         'side_angle-deg' : -0.52511924} 
#         
#     results = demo.predictdownrange(launch)
#     
#     
#     results[1]

#From model predictions
py_aero_predict = r.aero_data

test = []
for k, row in py_aero_predict.iterrows():
  results = demo.predictdownrange(row)
  test.append(results)

trajectory, results = zip(*test)

df = pd.DataFrame(results)
df2 = pd.DataFrame(trajectory)
#df2 = pd.DataFrame(trajectory[1])
#df3 = pd.DataFrame(trajectory[31])
#df4 = pd.DataFrame(trajectory[61])

```

```{r , echo=FALSE, include = TRUE, warning=FALSE}

df_1 <- data.frame(reticulate::py$df)
#df_2 <- data.frame(reticulate::py$df2)

predict_data$Carry.aero <- df_1$carry_yd
predict_data$Offline.aero <- df_1$carryDisp_yd

#predict_data <- predict_data %>% group_by(Club) %>% mutate(obs = n()) %>% filter(obs > 5)
model_col_names <- c("Model", "Length", "Ball.Speed", "Back.Spin", "Launch.Angle", "Side.Spin", "Side.Angle", "Carry.aero", "Offline.aero")
colnames(predict_data) <- model_col_names
predict_data$Model <- rep(c("Tahoe", "Tahoe HL"), each = 48)
predict_data

```


```{r , echo=FALSE, include = TRUE, warning=FALSE}

predict_data$Club[predict_data$Model == "Tahoe" & predict_data$Length== 35.75] <- "PW"
predict_data$Club[predict_data$Model == "Tahoe" & predict_data$Length== 36.00] <- "9"
predict_data$Club[predict_data$Model == "Tahoe" & predict_data$Length== 36.625] <- "8"
predict_data$Club[predict_data$Model == "Tahoe" & predict_data$Length== 37.25] <- "7"
predict_data$Club[predict_data$Model == "Tahoe" & predict_data$Length== 37.875] <- "6"
predict_data$Club[predict_data$Model == "Tahoe" & predict_data$Length== 38.50] <- "5"
#predict_data$Club[predict_data$Club == "Tahoe" & predict_data$Length== 39.125] <- "4"

predict_data$Club[predict_data$Model == "Tahoe HL" & predict_data$Length== 35.75] <- "PW"
predict_data$Club[predict_data$Model == "Tahoe HL" & predict_data$Length== 36.00] <- "9"
predict_data$Club[predict_data$Model == "Tahoe HL" & predict_data$Length== 36.75] <- "8"
predict_data$Club[predict_data$Model == "Tahoe HL" & predict_data$Length== 37.50] <- "7"
predict_data$Club[predict_data$Model == "Tahoe HL" & predict_data$Length== 38.25] <- "6"
predict_data$Club[predict_data$Model == "Tahoe HL" & predict_data$Length== 39.00] <- "5"
#predict_data$Club[predict_data$Club == "Tahoe HL" & predict_data$Length== 39.750] <- "4"

predict_data <- within(predict_data, {
  Club <- factor(Club)
  Length <- factor(Length)
  Model <- factor(Model)
  })

```



Downrange Plots
---------------------------------------------------------------------------------------------------
```{r , echo=FALSE, include = TRUE, warning=FALSE}

predict_data_plot <- predict_data

predict_data_plot %>% group_by(Length, Model) %>% summarise(Carry.aero.avg = mean(Carry.aero), Carry.aero.sd = sd(Carry.aero))

predict_data_plot %>% group_by(Model, Length) %>% summarise(Ball.Speed = mean(Ball.Speed), Back.Spin = mean(Back.Spin), Launch.Angle = mean(Launch.Angle), Side.Spin = mean(Side.Spin), Side.Angle = mean(Side.Angle))

annotate_npc <- function(label, x, y, ...)
{
  ggplot2::annotation_custom(grid::textGrob(
    x = unit(x, "npc"), y = unit(y, "npc"), label = label, ...))
}

ggplot(predict_data_plot,  aes(x = Offline.aero, y = Carry.aero, color = Model, shape = Club)) + geom_point() + stat_ellipse(aes(color = Model, shape = Club), level = 0.85, type = "t")+ theme_classic(base_size = 18)+theme(legend.position = "right") + coord_cartesian(xlim = c(plyr::round_any(min(predict_data$Offline.aero)-0, 5, f = floor), plyr::round_any(max(predict_data$Offline.aero)+0, 5, f = ceiling)), ylim = c(plyr::round_any(min(predict_data$Carry.aero)-5, 10, f = floor), plyr::round_any(max(predict_data$Carry.aero)+10, 10, f = ceiling))) + ylab("Carry.predict (yds)") + xlab("Offline.predict (yds)")

```

```{r , echo=FALSE, include = TRUE, warning=FALSE}

trajectory <- predict_data %>% group_by(Model, Club) %>% summarise(Ball.Speed = mean(Ball.Speed), Back.Spin = mean(Back.Spin), Launch.Angle = mean(Launch.Angle), Side.Spin = mean(Side.Spin), Side.Angle = mean(Side.Angle), Carry.aero = mean(Carry.aero))

trajectory

#summary(Launch.Angle.Normalize)
```

```{r , echo=FALSE, include = FALSE, warning=FALSE}

model_col_names <- c("Model", "Club", "speed-mph", "back_spin-rpm", "launch_angle-deg", "side_spin-rpm",
                     "side_angle-deg")

colnames(trajectory) <- as.character(model_col_names)
aero_data <- trajectory %>% select("speed-mph", "back_spin-rpm", "launch_angle-deg", "side_spin-rpm",
                     "side_angle-deg")

```


```{python, echo=FALSE, include = FALSE, warning=FALSE, message = FALSE}

# 131.0761	5626.937	13.10392	-86.35503	-0.52511924
# 
# launch= {
#         'speed-mph':131.0761,
#         'back_spin-rpm' : 5626.937,
#         'launch_angle-deg' : 13.10392,
#         'side_spin-rpm' : -86.35503,
#         'side_angle-deg' : -0.52511924} 
#         
#     results = demo.predictdownrange(launch)
#     
#     
#     results[1]

#From model predictions
py_aero_predict = r.aero_data

test = []
for k, row in py_aero_predict.iterrows():
  results = demo.predictdownrange(row)
  test.append(results)

trajectory, results = zip(*test)

df = pd.DataFrame(results)
df2 = pd.DataFrame(trajectory)

trajectory_0 = trajectory[0]
trajectory_1 = trajectory[1]
trajectory_2 = trajectory[2]
trajectory_3 = trajectory[3]
trajectory_4 = trajectory[4]
trajectory_5 = trajectory[5]
trajectory_6 = trajectory[6]
trajectory_7 = trajectory[7]
trajectory_8 = trajectory[8]
trajectory_9 = trajectory[9]
trajectory_10 = trajectory[10]
trajectory_11 = trajectory[11]
```



```{r , echo=FALSE, include = TRUE, warning=FALSE}

#Create dataframe of trajectory by ball
df_0 <- cbind(levels(trajectory$Model)[1], levels(trajectory$Club)[1], data.frame(reticulate::py$trajectory_0))
colnames(df_0) <- c("Model", "Club", "X.yards", "Y.yards", "Z.yards", "Time") 
df_1 <- cbind(levels(trajectory$Model)[1], levels(trajectory$Club)[2], data.frame(reticulate::py$trajectory_1))
colnames(df_1) <- c("Model", "Club", "X.yards", "Y.yards", "Z.yards", "Time") 
df_2 <- cbind(levels(trajectory$Model)[1], levels(trajectory$Club)[3], data.frame(reticulate::py$trajectory_2))
colnames(df_2) <- c("Model", "Club", "X.yards", "Y.yards", "Z.yards", "Time") 
df_3 <- cbind(levels(trajectory$Model)[1], levels(trajectory$Club)[4], data.frame(reticulate::py$trajectory_3))
colnames(df_3) <- c("Model", "Club", "X.yards", "Y.yards", "Z.yards", "Time") 
df_4 <- cbind(levels(trajectory$Model)[1], levels(trajectory$Club)[5], data.frame(reticulate::py$trajectory_4))
colnames(df_4) <- c("Model", "Club", "X.yards", "Y.yards", "Z.yards", "Time")
df_5 <- cbind(levels(trajectory$Model)[1], levels(trajectory$Club)[6], data.frame(reticulate::py$trajectory_5))
colnames(df_5) <- c("Model", "Club", "X.yards", "Y.yards", "Z.yards", "Time") 
df_0b <- cbind(levels(trajectory$Model)[2], levels(trajectory$Club)[1], data.frame(reticulate::py$trajectory_6))
colnames(df_0b) <- c("Model", "Club", "X.yards", "Y.yards", "Z.yards", "Time") 
df_1b <- cbind(levels(trajectory$Model)[2], levels(trajectory$Club)[2], data.frame(reticulate::py$trajectory_7))
colnames(df_1b) <- c("Model", "Club", "X.yards", "Y.yards", "Z.yards", "Time") 
df_2b <- cbind(levels(trajectory$Model)[2], levels(trajectory$Club)[3], data.frame(reticulate::py$trajectory_8))
colnames(df_2b) <- c("Model", "Club", "X.yards", "Y.yards", "Z.yards", "Time") 
df_3b <- cbind(levels(trajectory$Model)[2], levels(trajectory$Club)[4], data.frame(reticulate::py$trajectory_9))
colnames(df_3b) <- c("Model", "Club", "X.yards", "Y.yards", "Z.yards", "Time") 
df_4b <- cbind(levels(trajectory$Model)[2], levels(trajectory$Club)[5], data.frame(reticulate::py$trajectory_10))
colnames(df_4b) <- c("Model", "Club", "X.yards", "Y.yards", "Z.yards", "Time")
df_5b <- cbind(levels(trajectory$Model)[2], levels(trajectory$Club)[6], data.frame(reticulate::py$trajectory_11))
colnames(df_5b) <- c("Model", "Club", "X.yards", "Y.yards", "Z.yards", "Time") 

predict_trajectory <- rbind(df_0, df_1, df_2, df_3, df_4, df_5, df_0b, df_1b, df_2b, df_3b, df_4b, df_5b)

#Correct variable type
predict_trajectory <- within(predict_trajectory, {
  Club <- factor(Club)
  MOdel <- factor(Club)
  })

ggplot(predict_trajectory, aes(x = X.yards, y = Z.yards*3, color = Model, shape = Club)) +
  geom_point() + xlab("Distance (yards)") + ylab("Height (ft)") + theme_classic()

```


# Sim test for distance from opening for randy
```{r , echo=FALSE, include = TRUE, warning=FALSE}
use_python("C:/Users/Quenten.hooker/AppData/Local/Programs/Python/Python39/python.exe", required=TRUE)
source_python('python_ref.py')


predict_data = c()
# predict_data <- data.frame(Ball.Speed = rep(c(82), each = 3),
#                            Launch.Angle = rep(c(33, 39, 45), 1),
#                            Back.spin = rep(c(12800), 3),
#                            Side.Angle = rep(c(0), 3),
#                            Side.Spin = rep(c(0), 3))

predict_data <- data.frame(Ball.Speed = c(175, 174.4, 173.8),
                           Launch.Angle = c(9.6, 10.33, 11.06),
                           Back.spin = c(2798, 2930, 3062),
                           Side.Angle = rep(c(0), 3),
                           Side.Spin = rep(c(0), 3))


model_col_names <- c("Ballspeed", "LaunchAngle", "Backspin", "SideAngle", "SideSpin")
colnames(predict_data) <- model_col_names
aero_data <- aerotest(predict_data)


downrange_data <- aero_data %>% select(carrydisp, carrydist)


traj_Z_data <- aero_data[["Z yards"]]
traj_Z_data <- as.data.frame(do.call(cbind, traj_Z_data))
traj_Z_data <- pivot_longer(traj_Z_data, cols=everything()) %>% arrange(name)

traj_X_data <- aero_data[["X yards"]]
traj_X_data <- as.data.frame(do.call(cbind, traj_X_data))
traj_X_data <- pivot_longer(traj_X_data, cols=everything()) %>% arrange(name)

traj_Y_data <- aero_data[["Y yards"]]
traj_Y_data <- as.data.frame(do.call(cbind, traj_Y_data))
traj_Y_data <- pivot_longer(traj_Y_data, cols=everything()) %>% arrange(name)

Traj <- data.frame(name = traj_X_data$name,
                   X.yards = traj_X_data$value,
                   Y.yards = traj_Y_data$value,
                   Z.yards = traj_Z_data$value)


Traj$name[Traj$name== "V1"] <- "BS= 82, LA= 33, backs= 12800"
Traj$name[Traj$name== "V2"] <- "BS= 82, LA= 39, backs= 12800"
Traj$name[Traj$name== "V3"] <- "BS= 82, LA= 45, backs= 12800"

axx <- list(
    title = "Distance (ft)"
)

axy <- list(
  range = c(-10,10),
  title = "Offline (ft)"
)

axz <- list(
  title = "Height (ft)"
)

fig <- plot_ly(Traj, x = ~X.yards*3, y = ~Y.yards*3, z = ~Z.yards*3, color = ~name, type = 'scatter3d', mode = 'lines', colors = c("red", "black", "blue")) %>%
      layout(scene = list(xaxis=axx,yaxis=axy,zaxis=axz))
    
#fig <- fig %>% add_lines(y = 0, x = c(0,100), line = list(color = "grey", width = 2), inherit = FALSE, showlegend = FALSE)
fig    


htmlwidgets::saveWidget(
                widget = fig, #the plotly object
                file = "ECPC_Lab_Wedge_Sim.html", #the path & file name
                selfcontained = TRUE #creates a single html file
                )

```


## Advanced model building



#### standard 80-20 train test evaluation, Ball Speed through set
```{r , echo=FALSE, include = TRUE, warning=FALSE}

sample.split(Data.Combined$Ball.Speed.quad, SplitRatio = 0.80)->split_index
train  <- subset(Data.Combined,split_index==T)
test <- subset(Data.Combined,split_index==F)


train <- within(train, {
  Player <- factor(as.character(Player))
  Tags <- factor(as.character(Tags))})

test <- within(test, {
  Player <- factor(as.character(Player))
  Tags <- factor(as.character(Tags))})


mod_regress <-lmer(Ball.Speed.quad ~
           # Fixed-effects
           1 + Length + I(Length^2) + Static.Loft + I(Static.Loft^2) + Model + Carry.quad +
           # Random-effects
           (1 + Length + I(Length^2) + Static.Loft + I(Static.Loft^2) + Carry.quad | Player), data = train)

#ggpredict(mod_regress)

predict(mod_regress,test)->result_regress


cbind(Actual=test$Ball.Speed.quad,Predicted=result_regress)->Final_Data
as.data.frame(Final_Data)->Final_Data

(Final_Data$Actual- Final_Data$Predicted)->error
cbind(Final_Data,error)->Final_Data

Final_Data <- Final_Data %>% na.omit()

rmse1<-sqrt(mean(Final_Data$error^2))
rmse1

ggplot(Final_Data, aes(x = Actual, y = Predicted)) + geom_point() + geom_smooth(method = "lm")

#ggplot(Data.Combined, aes(x = Length, y = Ball.Speed.quad)) + geom_point(aes(color = Player)) + geom_smooth(aes(color = Player), method = "lm", formula = y ~ x + I(x^2), se=TRUE, level = .8, linetype = 1)+ theme_classic() + theme(legend.key.size = unit(.5, 'cm'), legend.key.width= unit(.1, 'cm'), legend.text = element_text(size=7))

```

   
#### standard 80-20 train test evaluation, Launch Angle through set
```{r , echo=FALSE, include = TRUE, warning=FALSE}

sample.split(Data.Combined$Launch.Angle.quad, SplitRatio = 0.80)->split_index
train  <- subset(Data.Combined,split_index==T)
test <- subset(Data.Combined,split_index==F)


train <- within(train, {
  Player <- factor(as.character(Player))
  Tags <- factor(as.character(Tags))})

test <- within(test, {
  Player <- factor(as.character(Player))
  Tags <- factor(as.character(Tags))})


mod_regress <-lmer(Launch.Angle.quad ~
           # Fixed-effects
           1 + Length + I(Length^2) + Static.Loft + I(Static.Loft^2) + Model + Carry.quad +
           # Random-effects
           (1 + Length + I(Length^2) + Static.Loft + I(Static.Loft^2) + Carry.quad | Player), data = train)

#ggpredict(mod_regress)

predict(mod_regress,test)->result_regress


cbind(Actual=test$Launch.Angle.quad,Predicted=result_regress)->Final_Data
as.data.frame(Final_Data)->Final_Data

(Final_Data$Actual- Final_Data$Predicted)->error
cbind(Final_Data,error)->Final_Data

Final_Data <- Final_Data %>% na.omit()

rmse1<-sqrt(mean(Final_Data$error^2))
rmse1

ggplot(Final_Data, aes(x = Actual, y = Predicted)) + geom_point() + geom_smooth(method = "lm")

#ggplot(Data.Combined, aes(x = Length, y = Ball.Speed.quad)) + geom_point(aes(color = Player)) + geom_smooth(aes(color = Player), method = "lm", formula = y ~ x + I(x^2), se=TRUE, level = .8, linetype = 1)+ theme_classic() + theme(legend.key.size = unit(.5, 'cm'), legend.key.width= unit(.1, 'cm'), legend.text = element_text(size=7))

```   
   
   
#### standard 80-20 train test evaluation, Backspin through set
```{r , echo=FALSE, include = TRUE, warning=FALSE}

sample.split(Data.Combined$Back.Spin.quad, SplitRatio = 0.80)->split_index
train  <- subset(Data.Combined,split_index==T)
test <- subset(Data.Combined,split_index==F)


train <- within(train, {
  Player <- factor(as.character(Player))
  Tags <- factor(as.character(Tags))})

test <- within(test, {
  Player <- factor(as.character(Player))
  Tags <- factor(as.character(Tags))})


mod_regress <-lmer(Back.Spin.quad ~
           # Fixed-effects
           1 + Length + I(Length^2) + Static.Loft + I(Static.Loft^2) + Model +
           # Random-effects
           (1 + Length + I(Length^2) + Static.Loft + I(Static.Loft^2) | Player), data = train)

ggpredict(mod_regress)

predict(mod_regress,test)->result_regress


cbind(Actual=test$Back.Spin.quad,Predicted=result_regress)->Final_Data
as.data.frame(Final_Data)->Final_Data

(Final_Data$Actual- Final_Data$Predicted)->error
cbind(Final_Data,error)->Final_Data

Final_Data <- Final_Data %>% na.omit()

rmse1<-sqrt(mean(Final_Data$error^2))
rmse1

ggplot(Final_Data, aes(x = Actual, y = Predicted)) + geom_point() + geom_smooth(method = "lm")

#ggplot(Data.Combined, aes(x = Length, y = Ball.Speed.quad)) + geom_point(aes(color = Player)) + geom_smooth(aes(color = Player), method = "lm", formula = y ~ x + I(x^2), se=TRUE, level = .8, linetype = 1)+ theme_classic() + theme(legend.key.size = unit(.5, 'cm'), legend.key.width= unit(.1, 'cm'), legend.text = element_text(size=7))

```   
           
#### standard 80-20 train test evaluation, club head speed
```{r , echo=FALSE, include = TRUE, warning=FALSE}

Data.Combined.7I <- Data.Combined %>% filter(Club == "7 Iron")

Data.Combined.7I <- Data.Combined.7I %>% filter(Club.Speed.quad < 150, Club.Speed.quad > 50) 

sample.split(Data.Combined.7I$Club.Speed.quad,SplitRatio = 0.80)->split_index
train  <- subset(Data.Combined.7I,split_index==T)
test <- subset(Data.Combined.7I,split_index==F)


train <- within(train, {
  Player <- factor(as.character(Player))
  Tags <- factor(as.character(Tags))})

test <- within(test, {
  Player <- factor(as.character(Player))
  Tags <- factor(as.character(Tags))})


# mod_regress <-lmer(Club.Speed.quad ~
#            # Fixed-effects
#            1 + Ball.Speed.quad*Launch.Angle.quad*Side.Angle.quad*Side.Spin.quad*Back.Spin.quad*Tags +
#            # Random-effects
#            (1 + Ball.Speed.quad + Launch.Angle.quad + Side.Angle.quad + Side.Spin.quad + Back.Spin.quad| Player), data = train)

mod_regress <-lmer(Club.Speed.quad ~
           # Fixed-effects
           1 + Ball.Speed.quad + Launch.Angle.quad + Side.Angle.quad + Side.Spin.quad + Back.Spin.quad + Tags +
           # Random-effects
           (1 + Ball.Speed.quad + Launch.Angle.quad + Side.Angle.quad + Side.Spin.quad + Back.Spin.quad | Player), data = train)

ggpredict(mod_regress)

predict(mod_regress,test)->result_regress


cbind(Actual=test$Club.Speed.quad,Predicted=result_regress)->Final_Data
as.data.frame(Final_Data)->Final_Data

(Final_Data$Actual- Final_Data$Predicted)->error
cbind(Final_Data,error)->Final_Data

Final_Data <- Final_Data %>% na.omit()

rmse1<-sqrt(mean(Final_Data$error^2))
rmse1

ggplot(Final_Data, aes(x = Actual, y = Predicted)) + geom_point() + geom_smooth(method = "lm")

```


#### standard 80-20 train test evaluation, attack
```{r , echo=FALSE, include = TRUE, warning=FALSE}

Data.Combined.7I <- Data.Combined %>% filter(Club == "7 Iron")

Data.Combined.7I <- Data.Combined.7I 

sample.split(Data.Combined.7I$Angle.Of.Attack.quad,SplitRatio = 0.80)->split_index
train  <- subset(Data.Combined.7I,split_index==T)
test <- subset(Data.Combined.7I,split_index==F)


train <- within(train, {
  Player <- factor(as.character(Player))
  Tags <- factor(as.character(Tags))})

test <- within(test, {
  Player <- factor(as.character(Player))
  Tags <- factor(as.character(Tags))})


# mod_regress <-lmer(Club.Speed.quad ~
#            # Fixed-effects
#            1 + Ball.Speed.quad*Launch.Angle.quad*Side.Angle.quad*Side.Spin.quad*Back.Spin.quad*Tags +
#            # Random-effects
#            (1 + Ball.Speed.quad + Launch.Angle.quad + Side.Angle.quad + Side.Spin.quad + Back.Spin.quad| Player), data = train)

mod_regress <-lmer(Angle.Of.Attack.quad ~
           # Fixed-effects
           1 + Ball.Speed.quad + Launch.Angle.quad + Side.Angle.quad + Side.Spin.quad + Back.Spin.quad + Lateral.Face.quad +
             Vertical.Face.quad + Tags +
           # Random-effects
           (1 + Ball.Speed.quad + Launch.Angle.quad + Side.Angle.quad + Side.Spin.quad + Back.Spin.quad | Player), data = train)


predict(mod_regress,test)->result_regress


cbind(Actual=test$Angle.Of.Attack.quad,Predicted=result_regress)->Final_Data
as.data.frame(Final_Data)->Final_Data

(Final_Data$Actual- Final_Data$Predicted)->error
cbind(Final_Data,error)->Final_Data

Final_Data <- Final_Data %>% na.omit()

rmse1<-sqrt(mean(Final_Data$error^2))
rmse1

ggplot(Final_Data, aes(x = Actual, y = Predicted)) + geom_point() + geom_smooth(method = "lm")

```

#### standard 80-20 train test evaluation, loft
```{r , echo=FALSE, include = TRUE, warning=FALSE}

Data.Combined.7I <- Data.Combined %>% filter(Club == "7 Iron")

Data.Combined.7I <- Data.Combined.7I 

sample.split(Data.Combined.7I$Loft.quad,SplitRatio = 0.80)->split_index
train  <- subset(Data.Combined.7I,split_index==T)
test <- subset(Data.Combined.7I,split_index==F)


train <- within(train, {
  Player <- factor(as.character(Player))
  Tags <- factor(as.character(Tags))})

test <- within(test, {
  Player <- factor(as.character(Player))
  Tags <- factor(as.character(Tags))})


# mod_regress <-lmer(Club.Speed.quad ~
#            # Fixed-effects
#            1 + Ball.Speed.quad*Launch.Angle.quad*Side.Angle.quad*Side.Spin.quad*Back.Spin.quad*Tags +
#            # Random-effects
#            (1 + Ball.Speed.quad + Launch.Angle.quad + Side.Angle.quad + Side.Spin.quad + Back.Spin.quad| Player), data = train)

mod_regress <-lmer(Pitch ~
           # Fixed-effects
           1 + Ball.Speed.quad + Launch.Angle.quad + Side.Angle.quad + Side.Spin.quad + Back.Spin.quad + Lateral.Face.quad +
             Vertical.Face.quad + Tags + 
           # Random-effects
           (1 + Ball.Speed.quad + Launch.Angle.quad + Side.Angle.quad + Side.Spin.quad + Back.Spin.quad | Player), data = train)

ggpredict(mod_regress)


predict(mod_regress,test)->result_regress


cbind(Actual=test$Loft.quad,Predicted=result_regress)->Final_Data
as.data.frame(Final_Data)->Final_Data

(Final_Data$Actual- Final_Data$Predicted)->error
cbind(Final_Data,error)->Final_Data

Final_Data <- Final_Data %>% na.omit()

rmse1<-sqrt(mean(Final_Data$error^2))
rmse1

ggplot(Final_Data, aes(x = Actual, y = Predicted)) + geom_point() + geom_smooth(method = "lm")

```  
  
  
```{r , echo=FALSE, include = TRUE, warning=FALSE}

Data.Combined.7I <- Data.Combined %>% filter(Club == "7 Iron")


lm.Club.Speed <-lmer(Club.Speed.quad ~
           # Fixed-effects
           1 + Ball.Speed.quad + Launch.Angle.quad + Side.Angle.quad + Side.Spin.quad + Back.Spin.quad +  Tags +
           # Random-effects
           (1 + Ball.Speed.quad + Launch.Angle.quad + Side.Angle.quad + Side.Spin.quad + Back.Spin.quad| Player), data = Data.Combined.7I)


# lm.Club.Speed <-lmer(Club.Speed.quad ~
#            # Fixed-effects
#            1 + Ball.Speed.quad*Launch.Angle.quad*Side.Angle.quad*Side.Spin.quad*Back.Spin.quad*Tags +
#            # Random-effects
#            (1 + Ball.Speed.quad + Launch.Angle.quad + Side.Angle.quad + Side.Spin.quad + Back.Spin.quad| Player), data = Data.Combined.7I)

# summary(lm.Club.Speed)
# 
# ggpredict(lm.Club.Speed)
```

## Person prediction testing - Me
```{r , echo=FALSE, include = TRUE, warning=FALSE}

new_data <- data.frame(Ball.Speed.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Ball.Speed.quad)),
                       Launch.Angle.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Launch.Angle.quad)),
                       Side.Angle.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Side.Angle.quad)),
                       Back.Spin.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Back.Spin.quad)),
                       Side.Spin.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Side.Spin.quad)),
                       Tags = rep(c("MB21"), each = 1),
                       Player = rep("Quenten Hooker", each = 1))

#summary(lm.Club.Speed)

colnames(new_data) <- c("Ball.Speed.quad", "Launch.Angle.quad", "Side.Angle.quad", "Back.Spin.quad", "Side.Spin.quad", "Tags", "Player")

predict(lm.Club.Speed, re.form= ~(1 + Ball.Speed.quad + Launch.Angle.quad + Side.Angle.quad + Side.Spin.quad + Back.Spin.quad| Player), newdata = new_data)
Data.Combined.7I %>% filter(Player == "Quenten Hooker", Tags == "MB21") %>% summarise(Club.Speed.quad = mean(Club.Speed.quad))
```


## Random simulations generating testing
```{r , echo=FALSE, include = TRUE, warning=FALSE}

new_data <- data.frame(Ball.Speed.quad = runif(100, min=110, max=130),
                       Launch.Angle.quad = runif(100, min=15.5, max=17),
                       Side.Angle.quad = runif(100, min=0, max=0),
                       Back.Spin.quad = runif(100, min=6000, max=8000),
                       Side.Spin.quad = runif(100, min=0, max=0),
                       Tags = rep(c("Tahoe Std"), each = 100),
                       Player = rep("Population", each = 100))

predict <- data.frame(Club.Speed.quad = predict(lm.Club.Speed, re.form= NA, newdata = new_data))


ggplot(predict, aes(x = Club.Speed.quad)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()

```

# Engage
## Load Packages
```{r , echo=TRUE, include = FALSE}

library('odbc')
library('DBI')
library('dplyr')

```


## Establish Connection
```{r, echo=FALSE, include = TRUE}

con <- DBI::dbConnect(odbc::odbc(),
                       Driver = "SQL Server",
                       Server = 'icgEngagedb.corp.callawaygolf.com',
                       Database = "Engage",                    
                       Trusted_Connection = "yes")

#dbListTables(con)
```

## Example SQL to grab data
```{r, echo=FALSE, include = TRUE}

Data.Engage <- DBI::dbGetQuery(con,
                              "SELECT Date, ShotId, FittingId, AccountFullName, Location, EventName, BallFamilyName, CategoryId, CategoryName, ClubFamilyId,
                              ClubFamilyName, MonitorTypeName, ImpactHeadSpeedMph, ImpactAttackAngleDeg, ImpactPathAngleDeg,
                              ImpactYawAngleDeg, ImpactPitchAngleDeg, ImpactRollAngleDeg, ImpactHorizLocInch, ImpactVertLocInch,
                              BallSpeedMph, BallLaunchAngleDeg, BallSideAngleDeg, BallBackSpinRpm, BallSideSpinRpm, ShotApexFt,
                              ShotMaxLateralTravelFt, ShotCarryYd, ShotCarryDispFt, ShotTotalYd, ShotTotalDispFt,
                              ShotFlightTimeSec, SmashFactor
                              FROM Engage.cg_Engage.vwMeasuredShotsAll;")

Data.Engage %>% group_by(MonitorTypeName) %>% summarise(n())
Data.Engage %>% group_by(Location) %>% summarise(n())

Data.Engage %>% filter(EventName == 'Callaway Performance Center - Carlsbad') %>% group_by(AccountFullName) %>% summarise(n())

Data_Engage_Quad_Carlsbad <- Data.Engage %>% filter(EventName == 'Callaway Performance Center - Carlsbad')

Data_Engage_Quad_Carlsbad %>% group_by(FittingId) %>% summarise(num = n()) %>% arrange(desc(num))

Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons") %>% group_by(ClubFamilyName) %>% summarise(num = n()) %>% arrange(desc(num))

```

#### MEM and RF, club head speed
```{r , echo=FALSE, include = TRUE, warning=FALSE}

Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")


Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph)) 

obs <- Data_Engage_Quad_Carlsbad_Iron_Select %>% group_by(FittingId) %>% summarise(num = n()) 
Data_Engage_Quad_Carlsbad_Iron_Select <- merge(Data_Engage_Quad_Carlsbad_Iron_Select, obs, by.x = c("FittingId"), by.y = c("FittingId")) 
Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(num > 7) 


Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)

#apply(Data_Engage_Quad_Carlsbad_Iron_Select,2,function(x) sum(is.na(x)))


sample.split(Data_Engage_Quad_Carlsbad_Iron_Select$ImpactHeadSpeedMph,SplitRatio = 0.80)->split_index
train  <- subset(Data_Engage_Quad_Carlsbad_Iron_Select,split_index==T)
test <- subset(Data_Engage_Quad_Carlsbad_Iron_Select,split_index==F)


Q_test_data <- data.frame(Ball.Speed.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Ball.Speed.quad)),
                       Launch.Angle.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Launch.Angle.quad)),
                       Side.Angle.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Side.Angle.quad)),
                       Back.Spin.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Back.Spin.quad)),
                       Side.Spin.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Side.Spin.quad)),
                       Tags = rep(c("APEX MB 21"), each = 1),
                       Player = rep("Quenten Hooker", each = 1))

colnames(Q_test_data) <- c("BallSpeedMph", "BallLaunchAngleDeg", "BallSideAngleDeg", "BallBackSpinRpm", "BallSideSpinRpm", "ClubFamilyName", "FittingId")

train <- within(train, {
  FittingId <- factor(as.character(FittingId))
  ClubFamilyName <- factor(as.character(ClubFamilyName))})

test <- within(test, {
  FittingId <- factor(as.character(FittingId))
  ClubFamilyName <- factor(as.character(ClubFamilyName))})

Q_test_data <- within(Q_test_data, {
  FittingId <- factor(as.character(FittingId))
  ClubFamilyName <- factor(as.character(ClubFamilyName))})


# mod_regress <-lmer(ImpactHeadSpeedMph ~
#            # Fixed-effects
#            1 + BallSpeedMph*BallLaunchAngleDeg*BallSideAngleDeg*BallBackSpinRpm*BallSideSpinRpm*ClubFamilyName +
#            # Random-effects
#            (1 + BallSpeedMph + BallLaunchAngleDeg + BallSideAngleDeg + BallBackSpinRpm + BallSideSpinRpm | FittingId), data = train)

mod_regress <-lmer(ImpactHeadSpeedMph ~
           # Fixed-effects
           1 + BallSpeedMph + BallLaunchAngleDeg + BallSideAngleDeg + BallBackSpinRpm + BallSideSpinRpm + ClubFamilyName +
           # Random-effects
           (1 + BallSpeedMph + BallLaunchAngleDeg + BallSideAngleDeg + BallBackSpinRpm + BallSideSpinRpm | FittingId), data = train)

# saveRDS(mod_regress, file = "mem.rda")

# mod_regress <-lmer(ImpactHeadSpeedMph ~
#            # Fixed-effects
#            1 + BallSpeedMph  +
#            # Random-effects
#            (1 + BallSpeedMph | FittingId), data = train)

# mod_regress <- randomForest(ImpactHeadSpeedMph  ~
#                               BallSpeedMph + BallLaunchAngleDeg + BallSideAngleDeg + BallBackSpinRpm + BallSideSpinRpm + ClubFamilyName,
#                             data = train, ntree=1000, importance=TRUE)

#ggpredict(mod_regress)

#unique(as.numeric(row.names(ranef(mod_regress)$FittingId)))

result_regress <- predict(mod_regress,test, allow.new.levels = TRUE)
#result_regress
predict(mod_regress,Q_test_data, allow.new.levels = TRUE)


Final_Data <- cbind(Actual=test$ImpactHeadSpeedMph,Predicted=result_regress)
Final_Data <- as.data.frame(Final_Data)

error <- (Final_Data$Actual- Final_Data$Predicted)
Final_Data <- cbind(Final_Data,error)

Final_Data <- Final_Data %>% na.omit()

rmse1<-sqrt(mean(Final_Data$error^2))
rmse1

MSE.mem <- sum((Final_Data$error)^2)/nrow(test)
MSE.mem

ggplot(Final_Data, aes(x = Actual, y = Predicted)) + geom_point() + geom_smooth(method = "lm")+ annotate(geom="text", x=60, y=110, label= paste("MSE = ", round(MSE.mem, 2))) + annotate(geom="text", x=60, y=105, label= paste("RMSE = ", round(rmse1, 2)))


```

# To do, restructure with above to test model vs mem

# NN for our inverse prediction problem using neuralnet package
```{r , echo=FALSE, include = TRUE, warning=FALSE}

#library('tidyverse')
library('neuralnet')

Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")

Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX TCB 21" ] <- "APEX_TCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX 21" ] <- "APEX_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX DCB 21" ] <- "APEX_DCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX PRO 21 IRONS" ] <- "APEX_PRO_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX MB 21" ] <- "APEX_MB_21"

Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph)) 

ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = SmashFactor)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = ImpactHeadSpeedMph)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()

Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)

data <- Data_Engage_Quad_Carlsbad_Iron_Select %>% select(ClubFamilyName, ImpactHeadSpeedMph, BallSpeedMph, BallLaunchAngleDeg, BallSideAngleDeg, BallBackSpinRpm, BallSideSpinRpm)

data <- unique(data)

#summary(data)

data <- data %>% mutate(value = 1)  %>% spread(ClubFamilyName, value,  fill = 0)

#check for NAs
apply(data,2,function(x) sum(is.na(x)))

index <- sample(1:nrow(data),round(0.75*nrow(data)))
train <- data[index,]
test <- data[-index,]
lm.fit <- glm(ImpactHeadSpeedMph~., data=train)
summary(lm.fit)
pr.lm <- predict(lm.fit,test)
MSE.lm <- sum((pr.lm - test$ImpactHeadSpeedMph)^2)/nrow(test)
rmse.lm <- sqrt(mean((pr.lm - test$ImpactHeadSpeedMph)^2))

maxs <- apply(data, 2, max) 
mins <- apply(data, 2, min)
scaled <- as.data.frame(scale(data, center = mins, scale = maxs - mins))
train_ <- scaled[index,]
test_ <- scaled[-index,]

n <- names(train_)

lhsOfFormula <- "ImpactHeadSpeedMph"
rhsOfFormula  <- paste(n[!n %in% "ImpactHeadSpeedMph"])
ns <- sapply(c(lhsOfFormula, rhsOfFormula), as.name)
f <- formula(paste(ns[1], paste(ns[-1], collapse="+"), sep=" ~ "))

#nn <- neuralnet(f,data=train_,hidden=c(5,3),linear.output=T)


nn <- neuralnet(formula = f, data = train_, hidden = 4, threshold = 0.01,
  stepmax = 1e+06, rep = 1, startweights = NULL,
  #learningrate.limit = NULL,
  #learningrate.factor = list(minus = 0.5,  plus = 1.2),
  learningrate = NULL, lifesign = "minimal",
  lifesign.step = 1000, algorithm = "rprop+", err.fct = "sse",
  act.fct = "logistic", linear.output = TRUE, exclude = NULL,
  constant.weights = NULL, likelihood = FALSE)

plot(nn)

pr.nn <- compute(nn,test_[,1:11])
pr.nn_ <- pr.nn$net.result*(max(data$ImpactHeadSpeedMph)-min(data$ImpactHeadSpeedMph))+min(data$ImpactHeadSpeedMph)
test.r <- (test_$ImpactHeadSpeedMph)*(max(data$ImpactHeadSpeedMph)-min(data$ImpactHeadSpeedMph))+min(data$ImpactHeadSpeedMph)
MSE.nn <- sum((test.r - pr.nn_)^2)/nrow(test_)
rmse.nn <- sqrt(mean((test.r - pr.nn_)^2))


print(paste(MSE.lm,MSE.nn))
print(paste(rmse.lm,rmse.nn))


par(mfrow=c(1,2))
plot(test$ImpactHeadSpeedMph,pr.nn_,col='red',main='Real vs predicted NN',pch=18,cex=0.7)
abline(0,1,lwd=2)
legend('bottomright',legend='NN',pch=18,col='red', bty='n')
plot(test$ImpactHeadSpeedMph,pr.lm,col='blue',main='Real vs predicted lm',pch=18, cex=0.7)
abline(0,1,lwd=2)
legend('bottomright',legend='LM',pch=18,col='blue', bty='n', cex=.95)

plot(test$ImpactHeadSpeedMph,pr.nn_,col='red',main='Real vs predicted NN',pch=18,cex=0.7)
points(test$ImpactHeadSpeedMph,pr.lm,col='blue',pch=18,cex=0.7)
abline(0,1,lwd=2)
legend('bottomright',legend=c('NN','LM'),pch=18,col=c('red','blue'))


```

# cross validation - Do not run
```{r , echo=FALSE, include = TRUE, warning=FALSE}


# library(boot)
# set.seed(200)
# lm.fit <- glm(ImpactHeadSpeedMph~.,data=data)
# cv.glm(data,lm.fit,K=10)$delta[1]
# 
# 
# set.seed(450)
# cv.error <- NULL
# k <- 10
# library(plyr) 
# pbar <- create_progress_bar('text')
# pbar$init(k)
# for(i in 1:k){
#     index <- sample(1:nrow(data),round(0.9*nrow(data)))
#     train.cv <- scaled[index,]
#     test.cv <- scaled[-index,]
#     nn <- neuralnet(f,data=train.cv,hidden=c(5,2),linear.output=T)   
#     pr.nn <- compute(nn,test.cv[,1:13])
#     pr.nn <- pr.nn$net.result*(max(data$ImpactHeadSpeedMph)-min(data$ImpactHeadSpeedMph))+min(data$ImpactHeadSpeedMph)   
#     test.cv.r <- (test.cv$ImpactHeadSpeedMph)*(max(data$ImpactHeadSpeedMph)-min(data$ImpactHeadSpeedMph))+min(data$ImpactHeadSpeedMph)   
#     cv.error[i] <- sum((test.cv.r - pr.nn)^2)/nrow(test.cv)    
#     pbar$step()
# }
# 
# mean(cv.error)
# cv.error
# 
# boxplot(cv.error,xlab='MSE CV',col='cyan',
#         border='blue',names='CV error (MSE)',
#         main='CV error (MSE) for NN',horizontal=TRUE)

```

# NN for our inverse prediction problem using neuralnet package
```{r , echo=FALSE, include = TRUE, warning = TRUE}

#library(quantmod) 
#library(nnet)
library('doMC')
library('tensorflow')
library('caret')

Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad %>% filter(CategoryName == "Irons", ClubFamilyName == "APEX TCB 21" | ClubFamilyName == "APEX 21" | ClubFamilyName == "APEX DCB 21" | ClubFamilyName == "APEX PRO 21 IRONS" | ClubFamilyName == "APEX MB 21")

Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX TCB 21" ] <- "APEX_TCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX 21" ] <- "APEX_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX DCB 21" ] <- "APEX_DCB_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX PRO 21 IRONS" ] <- "APEX_PRO_21"
Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName[Data_Engage_Quad_Carlsbad_Iron_Select$ClubFamilyName == "APEX MB 21" ] <- "APEX_MB_21"

# Data_Engage_Quad_Carlsbad_Iron_Select <- within(Data_Engage_Quad_Carlsbad_Iron_Select, {
#   ClubFamilyName <- factor(as.character(ClubFamilyName))})

Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(!is.na(ClubFamilyName), !is.na(ImpactHeadSpeedMph)) 

ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = SmashFactor)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()
ggplot(Data_Engage_Quad_Carlsbad_Iron_Select, aes(x = ImpactHeadSpeedMph)) + geom_histogram(aes(y = ..density..), colour = 1, fill = "white") +  geom_density()

Data_Engage_Quad_Carlsbad_Iron_Select <- Data_Engage_Quad_Carlsbad_Iron_Select %>% filter(SmashFactor > 1, ImpactHeadSpeedMph < 120, ImpactHeadSpeedMph > 50)

data <- Data_Engage_Quad_Carlsbad_Iron_Select %>% select(ClubFamilyName, ImpactHeadSpeedMph, BallSpeedMph, BallLaunchAngleDeg, BallSideAngleDeg, BallBackSpinRpm, BallSideSpinRpm)

data <- unique(data)

data <- data %>% mutate(value = 1)  %>% spread(ClubFamilyName, value,  fill = 0)

inTrain <- createDataPartition(
  y = data$ImpactHeadSpeedMph,
  times = 1,
  p = .80,
  list = FALSE
)

training <- data[ inTrain,]
testing  <- data[-inTrain,]
Q_test_data <- data.frame(Ball.Speed.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Ball.Speed.quad)),
                       Launch.Angle.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Launch.Angle.quad)),
                       Side.Angle.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Side.Angle.quad)),
                       Back.Spin.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Back.Spin.quad)),
                       Side.Spin.quad = Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Side.Spin.quad)),
                       APEX_21 = 0,
                       APEX_DCB_21 = 0,
                       APEX_MB_21 = 1,
                       APEX_PRO_21 = 0,
                       APEX_TCB_21 = 0)


colnames(Q_test_data) <- c("BallSpeedMph", "BallLaunchAngleDeg", "BallSideAngleDeg", "BallBackSpinRpm", "BallSideSpinRpm", "APEX_21", "APEX_DCB_21", "APEX_MB_21", "APEX_PRO_21", "APEX_TCB_21")

#new test
registerDoMC(cores=4)

#models tried, xgbLinear, xgbtree, ols, mem, randforest, neuralnet

tune.grid.neuralnet <- expand.grid(
  layer1 = c(5:10), # first hidden layer, from 1 to 5 neurons
  layer2 = c(0:5), # second hidden layer, from 0 to 5 neurons
  layer3 = c(0:5)  # third hidden layer, from 0 to 5 neurons
)

system.time(model <- caret::train(ImpactHeadSpeedMph ~ ., data = training, method = "neuralnet",
                                  preProcess = c("center", "scale"),
                                  tuneGrid = tune.grid.neuralnet, #dataframe of tunning values
                                  metric = "RMSE", #summary metric for selecting the optimal model
                                  stepmax = 1000000, #maximum steps for the training
                                  learningrate = 0.01, #amount that the weights are updated during training
                                  threshold = 2,
                                  # preProcess = list(center = c("ImpactHeadSpeedMph", "BallSpeedMph", "BallLaunchAngleDeg", "BallSideAngleDeg",
                                  #                                 "BallBackSpinRpm", "BallSideSpinRpm"),
                                  #                      scale = c("ImpactHeadSpeedMph", "BallSpeedMph", "BallLaunchAngleDeg", "BallSideAngleDeg",
                                  #                                 "BallBackSpinRpm", "BallSideSpinRpm")),
                                  #linout = TRUE,
                                  trControl = trainControl(method = 'cv', number = 2)
                                  ))

#saveRDS(model, file = "nn_5_0_0.rda")

#model1 <- readRDS(model, file = "nn_1_1.rda")

plot(model)
print(model)

result_predict <- predict(model,testing)
predict(model, Q_test_data)
Data.Combined.7I %>% filter(Player == "Quenten Hooker") %>% summarise(mean(Club.Speed.quad))




Final_Data <- cbind(Actual=testing$ImpactHeadSpeedMph,Predicted=result_predict)
Final_Data <- as.data.frame(Final_Data)

error <- (Final_Data$Actual- Final_Data$Predicted)
Final_Data <- cbind(Final_Data,error)

Final_Data <- Final_Data %>% na.omit()

rmse1<-sqrt(mean(Final_Data$error^2))
rmse1

MSE.mem <- sum((Final_Data$error)^2)/nrow(testing)
MSE.mem

ggplot(Final_Data, aes(x = Actual, y = Predicted)) + geom_point() + geom_smooth(method = "lm") + annotate(geom="text", x=60, y=110, label= paste("MSE = ", round(MSE.mem, 2))) + annotate(geom="text", x=60, y=105, label= paste("RMSE = ", round(rmse1, 2)))


```


## appendix 
```{r , echo=FALSE, include = TRUE, warning=FALSE}

control <- trainControl(method="repeatedcv", number=10, repeats=3)

n <- names(training)

lhsOfFormula <- "ImpactHeadSpeedMph"
rhsOfFormula  <- paste(n[!n %in% "ImpactHeadSpeedMph"])
ns <- sapply(c(lhsOfFormula, rhsOfFormula), as.name)
f <- formula(paste(ns[1], paste(ns[-1], collapse="+"), sep=" ~ "))


softplus <- function(x) log(1+exp(x)) #sigmoid activation function

tune.grid.neuralnet <- expand.grid(
  layer1 = c(4), # first hidden layer, from 1 to 5 neurons
  layer2 = c(0), # second hidden layer, from 0 to 5 neurons
  layer3 = c(0)  # third hidden layer, from 0 to 5 neurons
)
# 
# nn2 <- train(f, #formula 
#              training, # training dataset
#              method = "neuralnet", #modelling approach 
#              tuneGrid = tune.grid.neuralnet, #dataframe of tunning values 
#              metric = "RMSE", #summary metric for selecting the optimal model
#              stepmax = 100000, #maximum steps for the training
#              learningrate = 0.01, #amount that the weights are updated during training
#              threshold = 0.01, 
#              act.fct = softplus, 
#              trControl = trainControl (
#                  method = "repeatedcv", # crossvalidation method
#                  number  = 1,  # Number of folds of the cv
#                  repeats = 1,  # Number of cv repetitions
#                  p = 0.8,       # proportion of sample to be used as train set
#                  verboseIter = TRUE,
#                  savePredictions = TRUE,
#                  allowParallel = TRUE))

sapply(training, class) 
str(f)
warnings()
nn2 <- caret::train(f, #formula 
             training, # training dataset
             method = "neuralnet", #modelling approach 
             tuneGrid = tune.grid.neuralnet,
             #trace = TRUE,
             #linout = TRUE,
             preProc = c("center", "scale")) #dataframe of tunning values 
             #metric = "RMSE", #summary metric for selecting the optimal model
             #stepmax = 100, #maximum steps for the training
             #learningrate = 0.01, #amount that the weights are updated during training
             #threshold = 0.01,
             #act.fct = softplus, 
             #trControl = ctrl)

#method='neuralnet', linout=TRUE, trace = TRUE, preProc = c("center", "scale"), trControl = control)












sample.split(Data_Engage_Quad_Carlsbad_Iron_Select$ImpactHeadSpeedMph,SplitRatio = 0.80)->split_index
train  <- subset(Data_Engage_Quad_Carlsbad_Iron_Select,split_index==T)
test <- subset(Data_Engage_Quad_Carlsbad_Iron_Select,split_index==F)

train <- within(train, {
  FittingId <- factor(as.character(FittingId))
  ClubFamilyName <- factor(as.character(ClubFamilyName))})

test <- within(test, {
  FittingId <- factor(as.character(FittingId))
  ClubFamilyName <- factor(as.character(ClubFamilyName))})

summary(train)


maxs <- apply(Data_Engage_Quad_Carlsbad_Iron_Select, 2, max) 
mins <- apply(Data_Engage_Quad_Carlsbad_Iron_Select, 2, min)

scaled <- as.data.frame(scale(Data_Engage_Quad_Carlsbad_Iron_Select, center = mins, scale = maxs - mins))





#Trying stuff..


model = neuralnet(
    ImpactHeadSpeedMph ~ BallSpeedMph + BallLaunchAngleDeg + BallSideAngleDeg + BallBackSpinRpm + BallSideSpinRpm,
data=train,
hidden=c(4,2),
linear.output = FALSE
)

result_regress <- predict(model,test)


Final_Data <- cbind(Actual=test$ImpactHeadSpeedMph,Predicted=result_regress)
Final_Data <- as.data.frame(Final_Data)

error <- (Final_Data$Actual- Final_Data$Predicted)
Final_Data <- cbind(Final_Data,error)

Final_Data <- Final_Data %>% na.omit()

rmse1<-sqrt(mean(Final_Data$error^2))
rmse1

ggplot(Final_Data, aes(x = Actual, y = Predicted)) + geom_point() + geom_smooth(method = "lm")




plot(model,rep = "best")


pred <- predict(model, test)
prediction_label <- data.frame(max.col(pred)) %>% mutate(pred=max.col.pred.) %>%
unlist()

table(test, prediction_label)

```














